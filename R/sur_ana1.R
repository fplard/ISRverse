# WARNING - Generated by {fusen} from dev/flat_survival.Rmd: do not edit by hand

#' First-year survival Analysis
#' 
#' Run basta models on the first year after checking conditions for correct convergence of the models
#'
#' @param sexData \code{data.frame} including at least the following columns *AnimalAnonID*, *BirthDate*, *DepartDate*, *EntryDate*, *MaxBirthDate*, *MinBirthDate*, *EntryType*, *DepartType*, *FirstHoldingInstitution*, *LastHoldingInstitution*, *SexType*, and *BirthType*
#' @param DeathInformation  \code{data.frame} including at least the following columns *AnimalAnonID* and *RelevantDeathInformationType*
#' @param models \code{vector of characters} names of the basta models to run: "G0", "EX", "LO" and/or "WE". see ?basta for more information. Default = "GO"
#' @param shape \code{character} shape of the basta model: "simple", "Makeham", "bathtub".  see ?basta for more information. Default = "simple"
#' @param mindate \code{character 'YYYY-MM-DD'} Earlier date to include data
#' @param uncert_death \code{numeric}: Maximum uncertainty accepted for death date, in days
#' @param uncert_birth \code{numeric}: Maximum uncertainty accepted for birth date, in days
#' @param minNsur \code{numeric} Minimum number of individual records needed to run the survival analysis. Default = 50
#' @param maxNsur \code{numeric} Maximum number of individual records to run the survival analysis. Default = NULL
#' @param minInstitution \code{numeric} Minimum number of institutions that should hold records to run the survival analysis. Default = 1
#' @param niter  \code{numeric}. number of MCMC iterations to run. see ?basta for more information. Default = 25000
#' @param burnin  \code{numeric} Number of iterations removed so that the model has time to converge. see ?basta for more information. Default = 5001
#' @param thinning  \code{numeric} Number of iteration to run before saving a set of parameters. see ?basta for more information. Default = 20
#' @param nchain  \code{numeric} Number of chains to run. Default = 5001
#' @param ncpus  \code{numeric} Number of computer core to use. Default = 2
#'
#' @return The output of a list including:
#' * a summary of the data used:
#'- NGlobal: Number of captive born individuals selected from global collections
#'- NBasta: Number of data (individuals) selected for the BaSTA/survival analysis
#'- Ndead:Number of individuals with known age of death used in the BaSTA/survival analysis
#'- maxAge: Maximum age of known age individuals
#'- maxAlive:Maximum number of years spent ex situ
#'- lxMin:Minimum survivorship reached with the raw Kaplan-Meier model
#'-  OutLev: threshold selected for the distribution of  time spent alive: 100%, 99.9, 99 or 95%
#'- a logical indicated if the growth analysis was performed
#'-  If the survival analysis was not performed, an error and its number (Nerr) are returned: The possibility for  this functions are: 1/Nglobal < minNsur; 2/lxMin > minlx; 3/NBasta = 0; 4/ %known births < MinBirthKnown; 5/Data from 1 Institution; 6/Nbasta < minNsur; 7/Nbasta < maxNsur; 8/no DIC from Basta.
#'* the basta fit of the best model
#'* the DIC table comparing the different fit of the models
#' 
#' @export
#'
#' @examples
#' data(core)
#' data(deathinformation)
#' out <- Sur_ana1(core,  DeathInformation = deathinformation, models = "GO", shape = "simple",
#'                 niter = 1000, burnin = 101, thinning = 10, nchain = 3, ncpus = 3)
Sur_ana1 <- function(sexData, DeathInformation, models = "GO", shape = "simple",
                     minNsur = 50,maxNsur = NULL, mindate = "1980-01-01",
                     uncert_birth=30,uncert_death=30,minInstitution = 1,
                     niter = 25000, burnin = 5001, thinning = 20, nchain = 3, ncpus = 2) {
  
  mindate = lubridate::as_date(mindate)
  assert_that(is.data.frame(sexData))
  assert_that(sexData %has_name% c("AnimalAnonID", "BirthDate", "DepartDate",
                                   "EntryDate", "MaxBirthDate", "MinBirthDate",
                                   "EntryType", "DepartType", "FirstHoldingInstitution", 
                                   "LastHoldingInstitution", "SexType", "BirthType"))
  assert_that(is.data.frame(DeathInformation))
  assert_that(DeathInformation %has_name% c("AnimalAnonID","RelevantDeathInformationType"))
  assert_that(is.numeric(minNsur))
  assert_that(is.double(minInstitution))
  assert_that(is.numeric(uncert_death))
  assert_that(is.numeric(uncert_birth))
  if(!is.null(maxNsur)) {
    assert_that(is.numeric(maxNsur))
  }else{maxNsur = nrow(sexData)}
  assert_that(minNsur > 0)
  assert_that(is.numeric(niter))
  assert_that(niter > 0)
  assert_that(is.numeric(burnin))
  assert_that(burnin > 0)
  assert_that(burnin < niter)
  assert_that(is.numeric(thinning))
  assert_that(thinning > 0)
  assert_that(thinning < niter)
  assert_that(is.numeric(nchain))
  assert_that(nchain > 0)
  assert_that(is.numeric(ncpus))
  assert_that(ncpus > 0)
  assert_that(is.character(models))
  assert_that(all(models %in% c("GO", "EX", "LO", "WE")))
  assert_that(is.character(shape))
  assert_that(all(shape %in% c("simple", "bathtub", "Makeham")))
    #Remove individuals with uncertainty in death date
  sexData <- sexData%>%
    filter((Death_Uncertainty < uncert_death)%>% replace_na(TRUE),
           (Birth_Uncertainty < uncert_birth)%>% replace_na(TRUE))%>%
    mutate(
      deparAge = (DepartDate - BirthDate) ,
      entryAge = (EntryDate - BirthDate) ,
      DepartType = ifelse(deparAge>365.25, "C", DepartType),
    )%>%
    filter(entryAge <= 365)
  sexData$DepartDate= as.Date(sexData$DepartDate)
  sexData$DepartDate[sexData$deparAge>365.25]= as.Date(sexData$EntryDate)[sexData$deparAge>365.25]+ 366
  

  
  #Initialize
  summar = list(
    NGlobal =  nrow(sexData), NBasta = 0, Ndead = 0, 
    maxAge = NULL, maxAlive = NULL, 
    lxMin = NULL, outLev = NULL, 
    analyzed = FALSE, Nerr = 0,  error ="")
  bastaRes = NULL
  DICmods = NULL
  
  if(nrow(sexData)>= minNsur){
    
    # Extract BaSTA table:
    bastalist <- surv_Bastab(sexData, DeathInformation = DeathInformation, earliestDate = mindate,
                             excludeStillbirth = TRUE)
    bastatab <- bastalist%>%
      mutate(
        bdun = Max.Birth.Date-Min.Birth.Date,
        aliveTime = (Depart.Date - Entry.Date) / 365.25)
    
 
    summar$NBasta <- nrow(bastatab)
    summar$Ndead <- nrow(bastatab%>%filter(Depart.Type =="D"))
    summar$maxAge <- as.numeric(max(bastatab$Depart.Date - bastatab$Birth.Date, na.rm = TRUE))
    summar$maxAlive <- as.numeric(max(bastatab$Depart.Date - bastatab$Entry.Date, na.rm = TRUE))
    
    if(summar$NBasta>0){
      if(summar$Ndead>0){
      #Check the percentage of individuals with known births
      #Check that we have more than 1 institution
      Instb =  unique(sexData$FirstHoldingInstitution[sexData$AnimalAnonID %in% bastatab$AnimalAnonID])
      Instl =  unique(sexData$LastHoldingInstitution[sexData$AnimalAnonID %in% bastatab$AnimalAnonID])
      if(length(unique(c(Instb,Instl)))>=minInstitution){
        if (summar$NBasta >= minNsur) {
          if(summar$NBasta <= maxNsur){
            tempList <- list()
            DICmods <- tibble(models,
                              DIC = 0)
            for (imod in 1:length(models)) {
              print(models[imod])
              tempList[[models[imod]]] <- BaSTA::basta(
                bastatab, dataType = "census", shape = shape, 
                model = models[imod], parallel = TRUE, 
                ncpus = ncpus, nsim = nchain,
                niter = niter, burnin = burnin, thinning = thinning)
              
              if (!is.na( tempList[[models[imod]]]$DIC[1])) {
                DICmods$DIC[imod] <-  tempList[[models[imod]]]$DIC["DIC"]
              }
            }
            if (all(DICmods$DIC == 0)) {
              print("more chains")
              for (imod in 1:length(models)) {
                print(models[imod])
                tempList[[models[imod]]] <- BaSTA::basta(
                  bastatab, dataType = "census", shape = shape,
                  ncpus = ncpus, nsim = nchain, 
                  niter = niter*4, burnin = burnin*4-3, thinning = thinning)
                if (!is.na(tempList[[models[imod]]]$DIC[1])) {
                  DICmods$DIC[imod] <-tempList[[models[imod]]]$DIC["DIC"]
                }
                
                
              } 
            }
            
            # BaSTA outputs:
            if (any(DICmods$DIC != 0)) {
                       a = which(DICmods$DIC == 0)
                   DICmods2 = DICmods
                   if(length(a)>0){
                     DICmods2 = DICmods2[-a,]
                   }
idModSel <- which(DICmods$DIC == min(DICmods$DIC, na.rm = TRUE))
              bastaRes <- tempList[[idModSel]]
              summar$analyzed = TRUE
            } else {
              summar$error = 'no DIC from Basta'
              summar$Nerr = 9
            }
          } else {
            summar$error = "Nbasta > maxNsur"
            summar$Nerr = 8
          }
        } else {
          summar$error = "Nbasta < minNsur"
          summar$Nerr = 7
        }
      }else{
        summar$error = "Data from 1 Institution"
        summar$Nerr = 6
      }
    }else{
      summar$error = "Ndead = 0"
      summar$Nerr = 5
    }
  }else{
      summar$error = "NBasta = 0"
      summar$Nerr = 4
    }
    } else {
    summar$ error = "Nglobal < minNsur"
    summar$ Nerr = 2
  }
  
  return(list(summary = summar, bastaRes = bastaRes, DICmods = DICmods))
}
