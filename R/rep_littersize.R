# WARNING - Generated by {fusen} from dev/flat_repro.Rmd: do not edit by hand

#' my_fun Title
#'
#' @return 1
#' @export
#'
Rep_littersize <- function() {
  littSumm <- list(NOffsp_prob = NULL,NParent_prob = NULL, 
                   NReprEvent = NULL,
                   analyzed = FALSE,error = "", Nerr= 0,
                   MeanLittSize = NULL, MedLittSize = NULL)
  
  subpar <- subpar %>%
    filter(Probability > parentProb)
  littSumm$NOffsp_prob <- Nrepros <- length(unique(subpar$AnonID))
  unParentID <- unique(subpar$ParentAnonID)
  littSumm$NParent_prob <- Nparent <- length(unParentID)
  
  if (sx == "Female" | (sx == "All" & !forceBySex[taxa])) {
    
    if(length(unique(subpar$currentInst))>1){
      
      #remove curretn inst to avoid duplicated lines
      subpar <- subpar%>%
        select(-currentInst)%>%
        distinct()
      if (nrow(subpar)>= minNrepro)  {
        
        nindVec <- c()
        parVec <- c()
        parAgeVec <- c()
        for (ip in 1:Nparent) {
          idp <- which(subpar$ParentAnonID == unParentID[ip])
          nIdp <- length(idp)
          ibAge <-as.numeric(subpar$Offspring_BirthDate[idp] - subpar$Parent_BirthDate[idp])
          ibSort <- sort(ibAge)
          ibDiff <- as.numeric(diff(ibSort))
          idNew <- which(ibDiff > 7)
          repEv <- rep(0, nIdp)
          repEv[1] <- 1
          repEv[-1][idNew] <- 1
          nRepEvs <- as.numeric(table(cumsum(repEv)))
          parAgeVec <- c(parAgeVec, ibSort[which(repEv == 1)] / 365.25)
          nindVec <- c(nindVec, c(nRepEvs))
          parVec <- c(parVec, rep(unParentID[ip], length(nRepEvs)))
        }
        littSizeDf <- data.frame(parentID = parVec, age = parAgeVec, 
                                 Noffsp = nindVec)
        unNind <- min(nindVec):max(nindVec)
        nind <- length(unNind)
        littSize <- matrix(NA, nind, 3, 
                           dimnames = list(NULL, c("littSize", "total", 
                                                   "prop")))
        littSize[, "littSize"] <- unNind
        for (iof in 1:nind) {
          littSize[iof, "total"] <- length(which(nindVec == unNind[iof]))
        }
        littSize[, "prop"] <- littSize[, "total"] / sum(littSize[, "total"], 
                                                        na.rm = TRUE)
        # Summary
        littSumm$MeanLittSize =  mean(nindVec)
        littSumm$MedLittSize = median(nindVec)
        littSumm$analyzed = TRUE 
        littSumm$NReprEvent= sum(littSize[, "total"])
      }
    }
  }
}
