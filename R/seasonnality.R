# WARNING - Generated by {fusen} from dev/flat_repro.Rmd: do not edit by hand

#' my_fun Title
#'
#' @return 1
#' @export
#' @importFrom lubridate yday month year
#'
#' @examples
# Rep_season <- function() {
#   #   # Find institutions and their hemisphere:
#   Inst <- newcore$FirstHoldingInstitution
#   idinst <- which(as.character(.institution$AnonInstitutionID) %in% Inst)
#   subinst <- .institution[idinst, ]
#   rownames(subinst) <- as.character(subinst$AnonInstitutionID)
#   subinst <- subinst[Inst, ]  
#   
#   # Find which are from the northern and southern hemisphere:
#   idnorth <- which(subinst$Latitude > 0)
#   idsouth <- which(subinst$Latitude < 0)
#   Hemisph <- rep(NA, nrow(subinst))
#   Hemisph[idnorth] <- "North"
#   Hemisph[idsouth] <- "South"
#   instHemisph <- data.frame(AnonInstID = subinst$AnonInstitutionID, 
#                             Continent = subinst$Continent, 
#                             Country = subinst$Country, 
#                             Hemisph = Hemisph)
#   
# --------------------------- #
#   # Seasonality in births:
#   # --------------------------- #
#   # Extract birth dates, years and months:
#   if ("All" %in% sexCats) {
#     if (sexDat$summary$All$N > 0) {
#       seasDat <- sexDat$data$All
#       nSeas <- nrow(seasDat)      
#     } else {
#       nSeas <- 0
#     }
#   } else if (sexDat$summary$Female$N > 0 & sexDat$summary$Male$N > 0) {
#     seasDat <- rbind(sexDat$data$Female, sexDat$data$Male)
#     nSeas <- nrow(seasDat)
#   } else if (sexDat$summary$Female$N > 0) {
#     seasDat <- sexDat$data$Female
#     nSeas <- nrow(seasDat)
#   } else if (sexDat$summary$Male$N > 0) {
#     seasDat <- sexDat$data$Male
#     nSeas <- nrow(seasDat)
#   } else {
#     nSeas <- 0
#   }
#   
#   
#   # Hemispheres:
#   seasNames <- c("All", "North", "South")
#   
#   
#   # Fill up no analysis case:
#   for (ii in 1:3) {
#     seas[[seasNames[ii]]] <- list(analyzed = FALSE, prob = NULL, Nbirth_raw = nSeas, Nbirth = 0, 
#                                   plv = list(xysc = NULL, levs = NULL, plmarg =  c(0, 1)), error = "", Nerr = 0, L80 = NULL)
#   }
#   
#   # Available data:
#   if (nSeas > 0) {
#     # Month indices and labels:
#     mon <- 1:12
#     monName <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", 
#                  "Sep", "Oct", "Nov", "Dec")
#     
#     # Extract birth dates, years and months:
#     DATAsea <- seasDat%>%
#       filter(MinBirthDate == MaxBirthDate,
#              grepl("Captive", seasDat$BirthType),
#              FirstCollectionScopeType == "Global")
#     
#     if (nrow(DATAsea) > 0) {
#       
#       DATAsea <- DATAsea%>%
#         mutate(birthYear = year(BirthDate),
#                birthDay <-(julian(as.Date(sprintf("%s-12-31", birthYear), 
#                                           format = "%Y-%m-%d")) - 
#                              julian(BirthDate)) / 365 * 2 * pi,
#                birthMonth = month(BirthDate))
#       
#       # Find which are from the northern and southern hemisphere:
#       spInsts <- subinst[DATAsea$FirstHoldingInstitution, ]
#       idnorth <- which(spInsts$Latitude > 0)
#       idsouth <- which(spInsts$Latitude < 0)
#       
#       # Store in report list:
#       for (ii in 1:3) {
#         DATAseason <- DATAsea
#         # Find which are from the northern and southern hemisphere:
#         if (ii == 2) {
#           DATAseason <- DATAsea[idnorth,]
#         } 
#         if (ii == 3) {
#           DATAseason <- DATAsea[idsouth,]
#         }
#         seas[[seasNames[ii]]]$Nbirth <-nrow(DATAseason)
#         
#         if(length(unique(DATAseason$FirstHoldingInstitution))>1){
#           if (nrow(DATAseason) >= MinNSeas) {
#             
#             #Find 80% of the births
#             L_80 = quantile(yday(DATAseason$BirthDate), c(0.1,0.9))
#             seas[[seasNames[ii]]]$L80 =as.numeric(L_80[2]-L_80[1])
#             # Find number of births per month:
#             moncounts <- sapply(mon, function(mm) {
#               length(which(DATAseason$birthMonth == mm))
#             })
#             
#             # Proportion of births per month:
#             monprob <- moncounts / sum(moncounts)
#             names(monprob) <- monName
#             
#             # Plot variables:
#             xysc <- ceiling(max(monprob) * 20) / 20 + 0.05
#             levs <- seq(0.05, xysc - 0.05, 0.05)
#             plmarg <- c(-1.01, 1.01) * xysc
#             seas[[seasNames[ii]]]$plv <- list(xysc = xysc, levs = levs, plmarg = plmarg)
#             
#             # Store outputs:
#             seas[[seasNames[ii]]]$analyzed = TRUE
#             seas[[seasNames[ii]]]$prob = monprob
#             
#             
#           }else{
#             seas[[seasNames[ii]]]$error = "Nbirth <= MinNSeas"
#             seas[[seasNames[ii]]]$Nerr = 4}
#         }else{
#           seas[[seasNames[ii]]]$error = "Data from 1 Institution"
#           seas[[seasNames[ii]]]$Nerr = 3}
#       }
#       
#     }else{ 
#       for (ii in 1:3) {
#         seas[[seasNames[ii]]]$error = "No exact birth month"
#         seas[[seasNames[ii]]]$Nerr = 2
#       }
#     }
#     
#   }else{     
#     for (ii in 1:3) {
#       seas[[seasNames[ii]]]$error = "NThres == 0"
#       seas[[seasNames[ii]]]$Nerr = 1
#     }
#   }
#   
#   
# }
