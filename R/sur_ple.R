# WARNING - Generated by {fusen} from dev/flat_survival.Rmd: do not edit by hand

#' Estimate raw survivorship from life table
#' 
#' @param sexData \code{data.frame} including at least the following columns *deparAge*, *entryAge* (\code{date}), and *DepartType* 
#'
#' @return A data frame including 3 colummns:
#' * Ages: the different ages
#' * Surv: survivorship
#' * event = 1 if the individual was dead at this age 
#' vs. 0 is the individual was left-censored at this age
#' 
#' @export
#'
#' @examples

# Product limit estimator:
#' entryAge = sample(c(1:10), 200, replace = TRUE)
#' data <- data.frame(
#'   entryAge = entryAge,
#'   deparAge =  entryAge + sample(c(0:10), 200, replace = TRUE),
#'   DepartType = sample(c('C', 'D'), 200, replace = TRUE))
#'
#'
#' out<-Sur_ple(data)
Sur_ple <- function(sexData) {
  assert_that(is.data.frame(sexData))
  assert_that(sexData %has_name% c("deparAge", "DepartType", "entryAge"))
  # Find records with same first and last age:
  sexData <- sexData%>%
    rowwise()%>%
    mutate(idsame = entryAge == deparAge,
           deparAge = round(ifelse(idsame, deparAge + 1/365.25, deparAge),1))%>%
    arrange(deparAge)
  
  # Number of ages:
  nage <-unique(sexData$deparAge)
  
  # Cx and delta:
  Cx <- rep(0, length(nage))
  delx <- rep(0, length(nage))
  
  # Fill up Cx and delta:
  ii = 0
  for (agev in nage) {
    ii = ii + 1
    idNx <-sexData %>%filter(entryAge <= agev,
                             deparAge >= agev)
    delx[ii] <- length(which(sexData$DepartType == "D"  & sexData$deparAge ==agev))
    Cx[ii] <- 1- delx[ii]/nrow(idNx)
    
  }
  
  # Calculate product limit estimator:
  ple <- cumprod(Cx)
  ple[ple<0]=0
  
  # Add age 0:
  if (nage[1] > 0) {
    nage <- c(0, nage)
    ple <- c(1, ple)
    delx<- c(0, delx)
  }
  
  # Output:
  pleTab <- data.frame(Ages = nage, ple = ple, event = delx)
  
  return(pleTab)
}

