# WARNING - Generated by {fusen} from dev/flat_select.Rmd: do not edit by hand

#' Prepare Animal data
#' 
#' Check dates and add needed columns to animal data
#'
#' @param Animal  \code{data.frame} including at least the following columns *AnimalAnonID*,  *BirthDate*, *BirthDateEstimateType*, *BirthDateEstimateStart*, *BirthDateEstimateEnd*, *BirthType*, *FirstAcquisitionDate*, *DeathDate*, *DeathDateEstimateType*, *DeathDateEstimateStart*, *DeathDateEstimateEnd*, *LastCommentEntryDate*, *BirthObserved*, *GlobalStatus*, and  *LastTXDate*
#' @param minBirthDate  \code{character}: Earlier possible date: date used when minimum birth or death date unknown
#' @param extractDate  \code{character}: Latest possible date in the data: date used when individuals are still alive
#'
#' @return The checked and prepared dataset
#' 
#' @details
#' This function add the columns: MinBirthDate, MaxBirthDate, MinDeathDate, MaxDeathDate, EntryDate, EntryType, DepartDate, DepartType, Birth_Uncertainty, and Death_Uncertainty. It removes individuals for which dates are not chronologically meaningful (i.e. birth date after death date) and for which Birth_Uncertainty is higher than \code{uncert_birth}.
#' 
#' @importFrom lubridate as_date
#' @importFrom tidyr replace_na
#' @export
#'
#' @examples
#' file = system.file("sci_Animal.csv", package = 'ISRverse')
#' ZIMSdirtest = dirname(file)
#'
#' data <- Load_Zimsdata	(taxa = "Reptilia", 
#'                        species = list(Reptilia = "All"),
#'                        ZIMSdir = ZIMSdirtest,
#'                        Animal = TRUE)
#'
#' Animal <- Prep_Animal(data$Reptilia$Animal, extractDate = lubridate::as_date("2023/12/23"))
#'
#' unlink(ZIMSdirtest, recursive = FALSE)
Prep_Animal <- function(Animal, minBirthDate = "1900-01-01",
                        extractDate) {
  minBirthDate = as.character(minBirthDate)
  extractDate = as.character(extractDate)
  
  assert_that(is.data.frame(Animal))
  assert_that(Animal  %has_name% c("AnimalAnonID",  "BirthDate", "BirthDateEstimateType", "BirthDateEstimateStart", "BirthDateEstimateEnd","BirthObserved", "GlobalStatus",
                                   "BirthType", "FirstAcquisitionDate", "DeathDate", "DeathDateEstimateType", "DeathDateEstimateStart", "DeathDateEstimateEnd", "LastCommentEntryDate", "LastTXDate"))
  
  
  # Min and max Birth and death Date
  Animal <- Animal%>%
    mutate(
      MinBirthDate = case_when(
        BirthDateEstimateType == "ApproxBefore" ~ minBirthDate,
        BirthDateEstimateType == "ApproxAfter" ~ BirthDate,
        BirthDateEstimateType == "Undetermined" ~ BirthDateEstimateStart,
        BirthDateEstimateType == "Indeterminate" ~ BirthDateEstimateStart,
        BirthDateEstimateType == "Range" ~ BirthDateEstimateStart,
        BirthDateEstimateType == "ApproxVariance" ~ BirthDateEstimateStart,
        BirthDateEstimateType == "" ~ BirthDateEstimateStart),
      MaxBirthDate = case_when(
        BirthDateEstimateType == "ApproxBefore" ~ BirthDate,
        BirthDateEstimateType == "ApproxAfter" ~ extractDate,
        BirthDateEstimateType == "Undetermined" ~ BirthDateEstimateEnd,
        BirthDateEstimateType == "Indeterminate" ~ BirthDateEstimateEnd,
        BirthDateEstimateType == "Range" ~ BirthDateEstimateEnd,
        BirthDateEstimateType == "ApproxVariance" ~ BirthDateEstimateEnd,
        BirthDateEstimateType == "" ~ BirthDateEstimateEnd
      ),
      MinDeathDate = case_when(
        DeathDateEstimateType == "ApproxBefore" ~ minBirthDate,
        DeathDateEstimateType == "ApproxAfter" ~ DeathDate,
        DeathDateEstimateType == "Undetermined" ~ DeathDateEstimateStart,
        DeathDateEstimateType == "Indeterminate" ~ DeathDateEstimateStart,
        DeathDateEstimateType == "Range" ~ DeathDateEstimateStart,
        DeathDateEstimateType == "ApproxVariance" ~ DeathDateEstimateStart,
        DeathDateEstimateType == "" ~ DeathDateEstimateStart),
      MaxDeathDate = case_when(
        DeathDateEstimateType == "ApproxBefore" ~ DeathDate,
        DeathDateEstimateType == "ApproxAfter" ~ extractDate,
        DeathDateEstimateType == "Undetermined" ~ DeathDateEstimateEnd,
        DeathDateEstimateType == "Indeterminate" ~ DeathDateEstimateEnd,
        DeathDateEstimateType == "Range" ~ DeathDateEstimateEnd,
        DeathDateEstimateType == "ApproxVariance" ~ DeathDateEstimateEnd,
        DeathDateEstimateType == "" ~ DeathDateEstimateEnd),
      MinBirthDate = lubridate::as_date(MinBirthDate),
      MaxBirthDate = lubridate::as_date(MaxBirthDate),
      BirthDate = lubridate::as_date(BirthDate),
      MinDeathDate = lubridate::as_date(MinDeathDate),
      MaxDeathDate = lubridate::as_date(MaxDeathDate),
      DeathDate = lubridate::as_date(DeathDate),
      FirstAcquisitionDate = lubridate::as_date(FirstAcquisitionDate),
      LastTXDate  = lubridate::as_date(LastTXDate),
      MinBirthDate = coalesce(MinBirthDate, BirthDate),
      MaxBirthDate = coalesce(MaxBirthDate, BirthDate),
      MinDeathDate = coalesce(MinDeathDate, DeathDate),
      MaxDeathDate = coalesce(MaxDeathDate, DeathDate))
  
  
  
  
  Animal <- Animal%>%
    filter ((BirthDate >= MinBirthDate)%>% replace_na(TRUE),
            (BirthDate <= MaxBirthDate)%>% replace_na(TRUE),
            (DeathDate >= MinDeathDate)%>% replace_na(TRUE),
            (DeathDate <= MaxDeathDate)%>% replace_na(TRUE)
    )
  
  # Entry and Depart
  Animal <- Animal%>%
    mutate(EntryDate = FirstAcquisitionDate,
           EntryType = ifelse(BirthObserved == "NO", "T", "B"),
           DepartDate = ifelse(is.na(DeathDate), LastTXDate, DeathDate),
           DepartDate = ifelse(GlobalStatus == "Alive", lubridate::as_date(extractDate), DepartDate),
           DepartType = ifelse(GlobalStatus == "Dead" | !is.na(DeathDate), "D", "C"),
           EntryDate = lubridate::as_date(EntryDate),
           DepartDate = lubridate::as_date( DepartDate))
  
  
  #Correct Entry Dates
  ID = which (Animal$EntryDate < Animal$MaxBirthDate)
  Animal$MaxBirthDate[ID]= Animal$EntryDate[ID] 
  
  ID = which (Animal$EntryType == "B" & Animal$EntryDate != Animal$BirthDate)
  Animal$EntryDate[ID] = Animal$MaxBirthDate[ID]
  
  ID = which (Animal$EntryType == "B" & is.na(Animal$EntryDate))
  Animal$EntryDate[ID] = Animal$MaxBirthDate[ID]
  
  
  
  #Correct Depart Dates
  Animal$DepartDate[Animal$DepartType == "D" & is.na(Animal$DeathDate)] = Animal$LastTXDate[Animal$DepartType == "D" & is.na(Animal$DeathDate)]
  Animal$DepartType[Animal$DepartType == "D" & is.na(Animal$DeathDate)] = "C"
  
  ID = which(is.na(Animal$DepartDate))
  Animal$DepartDate[ID] = Animal$LastCommentEntryDate[ID]
  Animal$DepartType[ID] = "C"
  
  #check Chronology in dates
  Animal <- Animal%>%
    filter ((BirthDate <= FirstAcquisitionDate)%>% replace_na(TRUE),
            (EntryDate <= DepartDate)%>% replace_na(TRUE),
            (DepartDate <= DeathDate)%>% replace_na(TRUE),
            (DeathDate >= LastTXDate)%>% replace_na(TRUE),
            (BirthDate <= DeathDate)%>% replace_na(TRUE),
            (DeathDate >= FirstAcquisitionDate)%>% replace_na(TRUE),
            (BirthDate <= LastTXDate)%>% replace_na(TRUE),
            (FirstAcquisitionDate <= LastTXDate)%>% replace_na(TRUE))%>%
    dplyr::select (-c(DeathDateEstimateStart, DeathDateEstimateEnd, BirthDateEstimateEnd, BirthDateEstimateStart)) %>%
    mutate(Birth_Uncertainty =  MaxBirthDate-MinBirthDate,
           Death_Uncertainty =  MaxDeathDate-MinDeathDate)
  
  return(Animal)
}
