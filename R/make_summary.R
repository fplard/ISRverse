# WARNING - Generated by {fusen} from dev/flat_main.Rmd: do not edit by hand

#' Summarize taxon profiles analyses
#' 
#' Produce summary tables and plots of the demographic analyses made for all species
#'
#' @param AnalysisDir  \code{character} Directory where to find the .Rdata files: Results of the analyses
#' @param SaveDir  \code{character} Directory where to save summary plots and tables
#' @param namefile \code{character} Suffix to add to the name of files produced if needed.
#' @param TaxaList \code{vector of character} names of the taxa studied.
#' @param BySex \code{list} of the taxa names indicating the sexes analyzed.
#' @param Sections \code{vector of character} names of the sections: "sur", "rep" and/or "gro".
#' @param MinAge \code{numeric} Ages at which the survival analyses started.
#' @return It saves summary tables and plots for each Sections and a general summary table. It returns the main summary table
#' @export
#' 
#' @importFrom ggplot2 ggplot scale_fill_brewer facet_wrap geom_bar labs position_dodge coord_flip
#' @importFrom ggpubr ggarrange
#' 
#' @examples
#' # file = system.file("sci_Animal.csv", package = 'ISRverse')
#' # AnalysisDir  = paste0(dirname(file),'/Rdata')
#' # SaveDir = paste0(tempdir(check = TRUE),'/temp')
#' # dir.create(SaveDir)
#' # 
#' # SummTab <- make_summary(AnalysisDir, SaveDir,
#' #                         TaxaList = "Reptilia",
#' #                         BySex = list(Reptilia = c("Male", "Female")) ,
#' #                         Sections = c("sur", 'gro')
#' # )
#' # list.files(SaveDir)
#' # 
#' # unlink(SaveDir, recursive = TRUE)
make_summary <- function (AnalysisDir, SaveDir, namefile = "",
                          TaxaList = "Mammalia", 
                          BySex = list(Mammalia = c("Male", "Female")) , 
                          Sections = c("sur", 'rep', 'gro'), MinAge = 0
){
  nullToNA <- function(x) {
    x[sapply(x, is.null)] <- NA
    return(x)
  }
  # Check correct format for inputs -----------------------------------------------------------------------
  assert_that(is.character(TaxaList))
  assert_that(is.character(Sections))
  assert_that(all(Sections %in% c("sur", "gro", "rep")))
  checkmate::assert_directory_exists(AnalysisDir)
  checkmate::assert_directory_exists(SaveDir)
  assert_that(is.character(namefile))
  assert_that(is.list(BySex))
  assert_that(all(TaxaList %in% names(BySex)), msg = "BySex should be a list with names identical to TaxaList")
  assert_that(is.numeric(MinAge))
  assert_that(MinAge>=0)
  ModelsSurt = stringr::str_c("from", MinAge)
  
  # List of available analysis Results  -----------------------------------------------------------------------
  SRGlist <- list.files(AnalysisDir, pattern = ".RData")
  assert_that(length(SRGlist) > 0, 
              msg = glue::glue("There are no result file in {AnalysisDir}"))
  SRGsps <- gsub(".RData", "", SRGlist)
  
  # Loop over taxa: load result for each species and save summary metrics --------------------------------------
  icount <- 0
  for (Taxa in TaxaList) {
    SRGsps_ta = SRGsps%>%stringr::str_subset(Taxa)
    SRGspecies <- SRGsps_ta%>%
      stringr::str_remove(pattern = paste0(Taxa, '_'))%>%
      stringr::str_replace("_", " ")
    SexCats <- BySex [[Taxa]]
    icount <- icount + 1
    #Initialize tables ----------------------------------------------------------
    # main table giving summary of data used and selected
    table<-tibble(Class = rep(Taxa, length(SRGsps_ta)),
                  Species = SRGspecies,
                  Sex = "All",
                  Nraw = numeric(1),
                  Ndate = numeric(1),
                  Nglobal = numeric(1),
                  Nbirthtype = numeric(1),
                  Nuncertbirth = numeric(1),
                  Nalive = numeric(1),
                  firstDate = as.Date(x = integer(1), origin = "1980-01-01"),
                  maxAgeraw = numeric(1),
                  ExtractDate =  as.Date(x = integer(1), origin = "1980-01-01"),
                  
    )
    # table giving the longevity threshold which analyses were perfomed
    AnyAna<- tibble(Class = rep(Taxa, length( SRGsps_ta )*length(SexCats)),
                    Species = rep(SRGspecies, each = length(SexCats)),
                    Sex = rep(SexCats, length(SRGspecies)),
                    Nselect = numeric(1),
                    Nlifespan = numeric(1),
                    GapThresh = numeric(1),
                    NThres = numeric(1))
    # Survival tables
    if ("sur" %in% Sections){
      models = paste0("from", MinAge)
      tempsur <- tibble(Class = rep(Taxa, length( SRGsps_ta )*length(SexCats)*length(models)),
                        Species = rep(SRGspecies, each = length(SexCats)*length(models)),
                        Sex = rep(rep(SexCats,each = length(models)), length(SRGspecies)),
                        model = rep(models, length(SRGspecies)*length(SexCats)),
                        NSelect  = numeric(1), 
                        NUncertdeath = numeric(1), 
                        NBasta = numeric(1), 
                        Ndead = 0, 
                        lxMin = numeric(1),
                        maxAlive = numeric(1),
                        outLev = numeric(1),
                        analyzed = FALSE, 
                        Nerr = 1, 
                        error = "Nselect < MinN",
                        Gof_KM_coeff1 = numeric(1),
                        Gof_KM_coeff2 = numeric(1))
      Finsur =  tibble( Species = character(0),
                        Sex = character(0),
                        model = character(0),
                        ModelSur = character(0),
                        Life_expe = numeric(0), 
                        Remex0 = numeric(0), 
                        # Remex1 = numeric(0), 
                        L50 = numeric(0), 
                        L90 = numeric(0)
      )
      
    }else{tempsur = tibble()}
    # Growth tables
    if ("gro" %in% Sections){
      tempgro <-  tibble(Class = rep(Taxa, length( SRGsps_ta )*length(SexCats)),
                         Species = rep(SRGspecies, each = length(SexCats)),
                         Sex = rep(SexCats, length(SRGspecies)),
                         NWeight_raw = numeric(1), NInd_raw = numeric(1), 
                         NWeight_val = numeric(1), NInd_val = numeric(1), 
                         agemat = numeric(1), 
                         NJuv = numeric(1),NJuv_keep = numeric(1),
                         NAd = numeric(1), NAd_keep = numeric(1),
                         NWeight = numeric(1), NInd = numeric(1), 
                         analyzed = FALSE, 
                         Nerr = 1, 
                         error = "Nselect < MinN",)
    }else{tempgro = tibble()}
    # Reproduction tables
    if ("rep" %in% Sections){
      temprep <-  tibble(Class = rep(Taxa, length( SRGsps_ta )*length(SexCats)),
                         Species = rep(SRGspecies, each = length(SexCats)),
                         Sex = rep(SexCats, length(SRGspecies)),
                         Nbirths = numeric(1),
                         Nadults= numeric(1),
                         NOffsp= numeric(1),
                         NParent= numeric(1),
                         NOffsp_age=numeric(1),
                         NParent_age=numeric(1),
                         analyzed = FALSE, 
                         Nerr = 1, 
                         error = "Nselect < MinN",
                         amat_analyzed = logical(1),  
                         litt_analyzed = logical(1))
    }else{temprep = tibble()}
    
    # Loop over species
    i = 0
    for (isp in SRGsps_ta) {
      i = i+1
      specie =isp%>%
        stringr::str_remove(pattern = paste0(Taxa, '_'))%>%
        stringr::str_replace("_", " ")
      
      cat("\n", Taxa,": ", SRGspecies[i], "--", round(i / length(SRGsps_ta) * 100, 1),"%")
      
      # SRG file:
      load(glue::glue("{AnalysisDir}/{isp}.RData"))
      
      # Update each table
      table = table%>%
        rows_update(repout$general%>%nullToNA%>%as_tibble %>% 
                      mutate(Species = specie, Sex = "All"), 
                    by = c("Species", "Sex"), unmatched = "ignore")
      # Loop over sex categories
      for (sx in SexCats) {
        if(length(repout$summar[[sx]])>0){
          AnyAna = AnyAna%>%
            rows_update(repout$summar[[sx]]%>%nullToNA%>%as_tibble() %>% 
                          mutate(Species = specie, Sex = sx), 
                        by = c("Sex", "Species"), unmatched = "ignore")
        }
        if("sur" %in% Sections){
          nam = names(repout$surv[[sx]])
          nam = nam[nam %in% ModelsSurt]
          for( n in 1:length(nam)){
            if(length(repout$surv[[sx]][[n]]$summary)>0){
              tempsur <- tempsur%>%
                rows_update(repout$surv[[sx]][[n]]$summary%>%nullToNA%>%
                              as_tibble() %>% dplyr::select(-maxAge)%>%
                              mutate(Species = specie, 
                                     Sex = sx,
                                     model = nam[[n]]), 
                            by = c("Sex", "Species", "model"), unmatched = "ignore")
              
              MLE = tibble( Species = specie, Sex = sx, model = nam[[n]],
                            ModelSur = repout$surv[[sx]][[n]]$bastaRes$modelSpecs[["model"]],
                            Life_expe= repout$surv[[sx]][[n]]$bastaRes$PS$nocov$PS[1,1], 
                            Remex0 = repout$surv[[sx]][[n]]$relex_from0$RemLExp[c(1)], 
                            # Remex1 = repout$surv[[sx]][[n]]$relex$RemLExp[c(101)],
                            L50 = repout$surv[[sx]][[n]]$metrics$L50$L,
                            L90 = repout$surv[[sx]][[n]]$metrics$L90$L)  
              Finsur = Finsur%>%rows_append(MLE)
              
            }}
        }
        if("gro" %in% Sections){
          if(length(repout$weig[[sx]]$Captive$wSummar)>0){
            tempgro <- tempgro%>%
              rows_update(repout$weig[[sx]]$Captive$wSummar%>%nullToNA%>%as_tibble() %>% 
                            mutate(Species = specie, Sex = sx), 
                          by = c("Sex", "Species"), unmatched = "ignore")
          }
        }
        if("rep" %in% Sections){
          if(length(repout$rep[[sx]]$summary)>0){
            temprep <- temprep%>%
              rows_update(repout$rep[[sx]]$summary%>%as_tibble() %>% 
                            mutate(Species = specie, Sex = sx), 
                          by = c("Sex", "Species"), unmatched = "ignore")
          }}
      }
    }
    tempsur <- tempsur%>%
      left_join(  Finsur, by = c("Sex", "Species", "model") )
    if (icount == 1) {
      SummTab <-table
      SurTab <- tempsur
      RepTab <- temprep
      GroTab <- tempgro
    } else {
      SummTab <- rbind(SummTab, table)
      SurTab <- rbind(SurTab, tempsur)
      RepTab <- rbind(RepTab, temprep)
      GroTab <- rbind(GroTab, tempgro)
    }
    
  }
  # Write section tables and plots --------------------------------------------------
  #Survival outputs
  if("sur" %in% Sections){
    #Add survival analysis to table AnyAna
    AnyAna <-AnyAna%>%
      left_join(SurTab%>%
                  select(c(Species, Sex, NBasta, analyzed, error))%>%
                  rename(Surv_Ana = analyzed, Surv_error = error), 
                by = c("Species", "Sex"))
    
    utils::write.csv(SurTab, file = glue::glue("{SaveDir}/SRGs_Survival{namefile}.csv"),
                     row.names = FALSE)
    readr::write_excel_csv2(SurTab, file = glue::glue("{SaveDir}/SRGs_Survival{namefile}2.csv"))
    #Plot survival errors
    Surtabsum <- SurTab %>% 
      mutate(error =ifelse(error =="", "Analyzed",error),
             error = factor(error, levels = c('Analyzed','Nselect < MinN','Nuncertdeath < MinNSur', 
                                              "NBasta = 0", "%known births < MinBirthKnown",
                                              "Data from 1 Institution","Nbasta > MaxNSur",
                                              "Nbasta < MinNSur",
                                              "lxMin > MinLx",
                                              "no DIC from Basta", 
                                              "Kaplan-Meier does not fit",
                                              "lx[MLE] < MinMLE",
                                              "Min(Life_exp) >= MaxLE",
                                              "Kaplan-Meier does not fit:2"), 
                            ordered = T)) %>% 
      group_by(Class, Sex, error)%>% summarize(N = n())
    p<- ggplot(data = Surtabsum, aes(x = error, y = N, fill = Sex)) +
      geom_bar(stat = "identity", position = position_dodge()) +
      scale_fill_brewer(palette = "Spectral")+
      labs(x = "") + facet_wrap(~ Class, scales = "free")+
      coord_flip()
    ggsave( glue::glue("{SaveDir}/Survival_error{namefile}.pdf"), p, width = 20, height = 6)
    
  }
  
  # if("rep" %in% Sections){ 
  #   AnyAna <-AnyAna%>%
  #     left_join(RepTab%>%
  #                 select(Species, Sex, NOffsp_raw, NParent_raw, NOffsp,NParent, 
  #                        NAdult_rep, Fert_Analyzed,Fert_error,
  #                        NOffsp_prob,NParent_prob, NReprEvent,Litt_Analyzed,Litt_error,
  #                        SeasNorth_Analyzed, SeasNorth_error, SeasNorth_Nbirth,
  #                        SeasSouth_Analyzed, SeasSouth_error, SeasSouth_Nbirth)%>%
  #                 rename(Fert_Ana = Fert_Analyzed,
  #                        Litt_Ana = Litt_Analyzed,
  #                        SeasNorth_Ana = SeasNorth_Analyzed,
  #                        SeasSouth_Ana = SeasSouth_Analyzed), 
  #               by = c("Species", "Sex"))
  #   
  #   
  #   utils::write.csv(RepTab, file =  glue::glue("{SaveDir}/SRGs_Reproduction{namefile}.csv", globDir),
  #                    row.names = FALSE)
  #   
  #   Ferttabsum <- RepTab  %>% tidyr::drop_na(Fert_error)%>% 
  #     mutate(Fert_error = ifelse(Fert_error =="", "Analyzed",Fert_error),
  #            Fert_error = factor(Fert_error, levels =c('Analyzed','NThres == 0', 
  #                                                      "NAdult == 0", "NOffspr_age == 0",
  #                                                      "NParent_bd == 0", 
  #                                                      "Data from 1 Institution",
  #                                                      "NOffsp < MinNRepro",
  #                                                      "NParent < MinNPaRepro"), 
  #                                ordered = T)) %>% 
  #     group_by(Class, Sex, Fert_error)%>% summarize(N = n())
  #   fert<- ggplot(data=Ferttabsum, aes(x=Fert_error, y=N, fill=Sex)) +
  #     geom_bar(stat="identity", position=position_dodge()) +
  #     scale_fill_brewer(palette="Spectral")+
  #     labs(x = "Fertility")+
  #     facet_wrap(~Class, nrow = 1, scales = "free")+
  #     coord_flip()
  #   Litttabsum <- RepTab  %>% tidyr::drop_na(Litt_error) %>% 
  #     filter(Sex!="Male")%>%
  #     mutate(Litt_error =ifelse(Litt_error =="", "Analyzed",Litt_error),
  #            Litt_error =ifelse(Litt_error =="NOffsp  < MinNRepro",
  #                               "NOffsp < MinNRepro",Litt_error),
  #            Litt_error = factor(Litt_error, levels = c('Analyzed','NThres == 0', 
  #                                                       "NParent_bd == 0", 
  #                                                       "NAdult == 0", "NOffspr_age == 0",
  #                                                       "NOffsp < MinNRepro", 
  #                                                       "NParent < MinNPaRepro",
  #                                                       "Data from 1 Institution",
  #                                                       "NOffsp_prob < MinNRepro"), 
  #                                ordered = T))%>% 
  #     group_by(Class, Sex, Litt_error)%>% summarize(N = n())
  #   lit<- ggplot(data=Litttabsum, aes(x=Litt_error, y=N, fill=Sex)) +
  #     geom_bar(stat="identity", position=position_dodge()) +
  #     scale_fill_brewer(palette="Spectral")+
  #     labs(x = "Litter Size")+
  #     facet_wrap(~Class, nrow = 1, scales = "free")+
  #     coord_flip()
  #   SeaNtabsum <- RepTab  %>% tidyr::drop_na(SeasNorth_error)%>%
  #     filter(Sex=="Female" | Class == "Actinopterygii")%>%
  #     mutate(SeasNorth_error =ifelse(SeasNorth_error =="", "Analyzed",SeasNorth_error),
  #            SeasNorth_error = factor(SeasNorth_error, levels = c('Analyzed',"NThres == 0", 
  #                                                                 "No exact birth month",
  #                                                                 "Data from 1 Institution",
  #                                                                 "Nbirth <= MinNSeas"), 
  #                                     ordered = T)) %>% 
  #     group_by(Class, SeasNorth_error)%>% summarize(N = n())
  #   seaN<- ggplot(data=SeaNtabsum, aes(x=SeasNorth_error, y=N)) +
  #     geom_bar(stat="identity", position=position_dodge()) +
  #     labs(x = "Seasonality North")+
  #     facet_wrap(~Class, nrow = 1, scales = "free")+
  #     coord_flip()
  #   SeaStabsum <- RepTab  %>% tidyr::drop_na(SeasSouth_error)%>% 
  #     filter(Sex=="Female" | Class == "Actinopterygii")%>%
  #     mutate(SeasSouth_error =ifelse(SeasSouth_error =="", "Analyzed",SeasSouth_error),
  #            SeasSouth_error = factor(SeasSouth_error, levels = c('Analyzed',"NThres == 0", 
  #                                                                 "No exact birth month", 
  #                                                                 "Data from 1 Institution",
  #                                                                 "Nbirth <= MinNSeas"), 
  #                                     ordered = T)) %>% 
  #     group_by(Class, SeasSouth_error)%>% summarize(N = n())
  #   seaS<- ggplot(data=SeaStabsum, aes(x=SeasSouth_error, y=N)) +
  #     geom_bar(stat="identity", position=position_dodge()) +
  #     labs(x = "Seasonality South")+
  #     facet_wrap(~Class, nrow = 1, scales = "free")+
  #     coord_flip()
  #   figure <- ggarrange(fert, lit, seaN,seaS,
  #                       # labels = c("A", "B", "C"),
  #                       ncol = 1, nrow = 4)
  #   ggsave( glue::glue("{SaveDir}/Reproduction_error{namefile}.pdf"), figure, width = 25, height = 15)
  #   
  # }          
  # 
  #Growth outputs
  if("gro" %in% Sections){ 
    #Add Growth analysis to table AnyAna
    AnyAna <-AnyAna%>%
      left_join(GroTab%>%
                  select(Species, Sex, NWeight_raw , NWeight, analyzed,error)%>%
                  rename(Gro_Ana = analyzed, Gro_error = error), 
                by = c("Species", "Sex"))
    
    
    utils::write.csv(GroTab, file = glue::glue("{SaveDir}/SRGs_Growth{namefile}.csv"),
                     row.names = FALSE)
    #Plot Growth errors
    Grotabsum <- GroTab  %>% tidyr::drop_na(error)%>% 
      mutate(error =ifelse(error =="", "Analyzed",error),
             error = factor(error, levels = c('Analyzed',"No known Sex", 
                                              "No weight for this sex category",
                                              "No valid weight measure", "Data from 1 Institution",
                                              "NWeight < MinNGro", "NInds < MinNIGro", "Model did not fit"), 
                            ordered = T)) %>%
      group_by(Class, Sex, error)%>% summarize(N = n())
    p<- ggplot(data=Grotabsum, aes(x=error, y=N, fill=Sex)) +
      geom_bar(stat="identity", position=position_dodge()) +
      scale_fill_brewer(palette="Spectral")+
      labs(x = "Growth")+facet_wrap(~Class, nrow = 2, scales = "free")+
      coord_flip()
    ggsave( glue::glue("{SaveDir}/Growth_error{namefile}.pdf"), p, width = 20, height = 6)
    
  }
  
  # Write main tables------------------------------------------------------------------
  AnyAna <-AnyAna%>%
    rowwise%>%
    mutate( Any_Ana = any(across(ends_with("Ana"))),
            All_Ana = all(across(ends_with("Ana"))))
  utils::write.csv(AnyAna, file =  glue::glue("{SaveDir}/SRGs_Any_Ana{namefile}.csv"),
                   row.names = FALSE)
  
  
  utils::write.csv(SummTab, file =  glue::glue("{SaveDir}/SRGs_Analyses{namefile}.csv"),
                   row.names = FALSE)
  return(SummTab)
}
