# WARNING - Generated by {fusen} from dev/flat_select.Rmd: do not edit by hand

#' Taxon profile report
#' 
#' Run the survival, reproduction and growth analysis for the selected species
#'
#' @param Taxa  \code{character} name of the taxa studied
#' @param Species \code{character} name of the species studied
#' @param Animal \code{data.frame} core data
#' @param Collection  \code{data.frame} Collection data
#' @param PlotDir \code{character} Directory to save the plots. Default: no plot is saved
#' @param DeathInformation \code{data.frame} including at least the following columns *AnimalAnonID* and *RelevantDeathInformationType*
#' @param Weights \code{data.frame} Weights data if the growth analysis is run
#' @param Parents \code{data.frame} Parents data if the reproduction analysis is run
#' @param Contraceptions \code{data.frame} Contraception data if the reproduction analysis is run
#' @param Move \code{data frame} Move data including at least the following columns: *AnimalAnonID*, *To*, *Date*
#' @param repout \code{list} Previous result of the taxon profile for this species if it needs to be updated only
#' @param Sections \code{vector of character} names of the sections to update in the taxon profile results: "sur", "rep" and/or "gro".
#' @param SexCats \code{character} Male, Female or All.
#' @param MinN \code{numeric} Minimum number of individuals needed to run the analyses.
#' @param MinDate \code{character 'YYYY-MM-DD'} Earliest date to include data
#' @param ExtractDate \code{character 'YYYY-MM-DD'} Date of data extraction
#' @param MinBirthDate  \code{character}: Earliest possible date: date used when minimum birth date unknown
#' @param BirthType \code{character} Captive, Wild, or All.
#' @param Global \code{logical} Whether only individuals belonging to global Collections should be used.
#' @param MinInstitution  \code{numeric} Minimum number of institutions that should hold records to run the analyses.
#' @param MinAge \code{numeric} Ages at which the survival analysis should start, in years.  see ?basta for more information.
#' @param MaxAge \code{numeric} Maximum possible age in years. Only used for model predictions. This argument is not used to select data.
#' @param UncertBirth \code{numeric}: Maximum uncertainty accepted for birth dates, in days
#' @param UncertDeath \code{numeric}: Maximum uncertainty accepted for death dates, in days.
#' @param UncertDate \code{numeric}: Maximum uncertainty accepted for measurement dates: weight, in days.
#' @param MinNSur \code{numeric} Minimum number of individual records needed to run the survival analysis.
#' @param MaxNSur \code{numeric} Maximum number of individual records to run the survival analysis.
#' @param MinBirthKnown  \code{numeric} between 0 and 1. Minimum proportion of individuals with a known birth month in the data to run the survival analysis.
#' @param MinLx  \code{numeric} Value used for longevity threshold and for checks. between 0 and 1. Minimum reached survivorship from the raw Kaplan Meier analysis. This number avoids running survival analysis if there are too few dead individuals in the data. Lower is better.
#' @param MinMLE \code{numeric} Value used for checks. Minimum survivorship allowed at mean life expectancy. Between 0 and 1.
#' @param MaxLE \code{numeric} Value used for checks. Maximum remaining life expectancy at last observed age. In years.
#' @param MaxOutl \code{numeric} Start threshold to select individuals based on the longevity distribution: 100%, 99.9, 99 or 95%. This number must decrease when many errors are expected in longevity data.
#' @param ModelsSur \code{vector of characters} Names of the survival basta models to run: "G0", "EX", "LO" and/or "WE". see ?basta for more information.
#' @param Shape \code{character} Shape of the survival basta model to run: "simple", "Makeham", "bathtub".  see ?basta for more information.
#' @param LastDead  \code{logical} Whether the longest lived individuals should be considered dead.
#' @param niter  \code{numeric}. number of MCMC iterations to run the survival model. see ?basta for more information.
#' @param burnin  \code{numeric} Number of iterations removed so that the survival model has time to converge. see ?basta for more information.
#' @param thinning  \code{numeric} Number of iterations to run the survival model before saving a set of parameters. see ?basta for more information.
#' @param nchain  \code{numeric} Number of chains to run the survival model.
#' @param ncpus  \code{numeric} Number of computer cores to use.
#' @param RepSect \code{character} Names of the reproductive analyses to run: "agemat", "litter" and/or ...
#' @param NDay \code{numeric} Number of consecutive days over which the birth dates of a litter/clutch can be spread.
#' @param ParentPercDam \code{numeric} Minimum percentage of parentage probability to include Dam.
#' @param ParentPercSire \code{numeric} Minimum percentage of parentage probability to include Sire.
#' @param MinNLitter \code{numeric} Minimum number of litters to run the analysis. The data frame for litter size will be produced in all cases.
#' @param MinNRepro \code{numeric} Minimum number of birth records needed to run reproductive analyses.
#' @param MinNPaRepro \code{numeric} Minimum number of unique parent records needed to run reproductive analyses.
#' @param MinNSeas \code{numeric} XXXXXXXXXXX
#' @param MinNGro \code{numeric} Minimum number of weights needed to fit the growth models.
#' @param MinNIGro \code{numeric} Minimum number of unique individuals needed to fit the growth models.
#' @param MeasureType \code{vector of characters} Name of the types of measurement that should be included.  Default =  all measurement type are included.
#' @param ModelsGro \code{vector of characters} Names of the growth models that need to be fit. The following models are supported : logistic, gompertz, chapmanRichards, vonBertalanffy, polynomial.
#' 
#' @return a list including the results and summary of each analysis. See each function ?Sur_main, ?Rep_main and ?Gro_main for more details about survival, reproduction and growth analyses, respectively.
#' @export
#' 
#' @importFrom grDevices rgb
#' @importFrom graphics polygon
#'
#' @examples
#' file = system.file("sci_Animal.csv", package = 'ISRverse')
#' ZIMSDirtest = dirname(file)
#' data <- Load_Zimsdata	(Taxa = "Reptilia",
#'                        Species = list(Reptilia = "All"),
#'                        ZIMSDir = ZIMSDirtest,
#'                        Animal = TRUE, tables = c("Collection","DeathInformation"))
#'
#' Animal<- Prep_Animal(data[["Reptilia"]]$Animal, ExtractDate="2024/08/29"  )
#' PlotDir = paste0(tempdir(check = TRUE),'/temp')
#' dir.create(PlotDir)
#'
#' out <- tx_report(Species = "Testudo hermanni", Taxa = "Reptilia",
#'                  Animal, data$Reptilia$Collection, 
#'                  BirthType = "All", UncertBirth = 3500,UncertDeath = 3500, 
#'                  DeathInformation =data$Reptilia$DeathInformation,
#'                  PlotDir = PlotDir,Sections = c('sur'),
#'                  SexCats = c("Male", "Female"),
#'                  ModelsSur = "GO", Shape = "simple",
#'                  ModelsGro = "vonBertalanffy",
#'                  niter = 1000, burnin = 101, thinning = 10, nchain = 3, ncpus = 3
#' )
#'
#' list.files(PlotDir)
#' unlink(PlotDir, recursive = TRUE)
#'
tx_report <- function(Species, Taxa,  Animal, Collection, PlotDir = NULL,
                      Weights = NULL,Parents = NULL, Move= NULL, 
                      Contraceptions = NULL, DeathInformation = NULL,
                      repout = list(), Sections = c('sur', 'rep', 'gro'),
                      SexCats = c("Male", "Female"), MinN = 50, MinDate= "1980-01-01",
                      Global = TRUE, MinBirthDate = "1900-01-01",
                      ExtractDate = NULL, UncertBirth = 365,  UncertDeath = 365,  UncertDate = 365, 
                      MinNSur = 50, MaxNSur = NULL, MinInstitution  = 2, 
                      MinLx = 0.1, MinBirthKnown = 0.3, MaxOutl = 100, MaxAge =120,
                      MinMLE = 0.1, MaxLE = 2, 
                      ModelsSur = "GO", Shape = "bathtub",
                      niter = 25000, burnin = 5001, thinning = 20, nchain = 3, 
                      ncpus = 2, MinAge = 0, LastDead = FALSE,
                      RepSect = c('agemat', 'litter'),
                      BirthType = "Captive", 
                      ParentPercDam = 80,  ParentPercSire = 80, MinNLitter = 20,NDay = 7,
                      MinNRepro = 100, MinNPaRepro = 30, MinNSeas = 50, 
                      MinNGro =100, MinNIGro = 50, MeasureType = "Live weight",
                      ModelsGro = "vonBertalanffy"
) {
  
  # Check correct format for inputs -----------------------------------------------------------------------
  assert_that(is.character(Taxa))
  assert_that(is.character(Sections))
  assert_that(all(Sections %in% c("sur", "gro", "rep")))
  assert_that(is.character(Species))
  assert_that(is.logical(Global))
  assert_that(BirthType %in% c("Captive", "Wild", "All"))
  assert_that(is.character(SexCats))
  assert_that(all(SexCats %in% c("Male", "Female", "All")))
  
  assert_that(is.data.frame(Animal))
  assert_that(is.data.frame(Collection))
  assert_that(Animal  %has_name% c("AnimalAnonID", "binSpecies", "BirthDate", "DepartDate",
                                   "EntryDate", "MaxBirthDate", "MinBirthDate",
                                   "MaxDeathDate", "MinDeathDate", "EntryType", "DepartType",
                                   "LastTXDate", "DeathDate", "FirstHoldingInstitution", 
                                   "LastHoldingInstitution","GlobalStatus",
                                   "LastCollectionScopeType","FirstCollectionScopeType"))
  assert_that(Collection  %has_name% c("RecordingInstitution", "ChangeDate", 
                                       "ScopeType", "AnimalAnonID"))
  if(!is.null(ExtractDate)){
    ExtractDate = lubridate::as_date(ExtractDate)
  } else{
    ExtractDate = max(lubridate::as_date(Animal$LastTXDate), na.rm = T)
  }   
  assert_that(is.numeric( MaxOutl))
  assert_that(MaxOutl <= 100)
  assert_that(is.numeric(UncertBirth))
  assert_that(is.numeric(UncertDeath))
  assert_that(is.numeric(UncertDate))
  assert_that(is.double(MinInstitution))
  assert_that(is.numeric(ncpus))
  assert_that(ncpus > 0)
  checkmate::assert_directory_exists(PlotDir)
  
  if("sur" %in% Sections){
    assert_that(is.data.frame(DeathInformation))
    assert_that(DeathInformation %has_name% c("AnimalAnonID","RelevantDeathInformationType"))
    if(!is.null(MaxNSur)) assert_that(is.numeric(MaxNSur))
    assert_that(is.numeric(MinNSur))
    assert_that(MinNSur > 0)
    assert_that(is.numeric(MinLx))
    assert_that(MinLx >= 0 & MinLx <= 1)
    assert_that(is.numeric(MinMLE))
    assert_that(MinMLE >= 0 & MinMLE <= 1)
    assert_that(is.numeric(MaxLE))
    assert_that(is.numeric(MinBirthKnown))
    assert_that(MinBirthKnown <= 1, msg ='MinBirthKnown must be a proportion, so between 0 and 1')
    assert_that(is.logical(LastDead))
    assert_that(is.numeric(niter))
    assert_that(niter > 0)
    assert_that(is.numeric(burnin))
    assert_that(burnin > 0)
    assert_that(burnin < niter)
    assert_that(is.numeric(thinning))
    assert_that(thinning > 0)
    assert_that(thinning < niter)
    assert_that(is.numeric(nchain))
    assert_that(nchain > 0)
    assert_that(is.character(ModelsSur))
    assert_that(all(ModelsSur %in% c("GO", "EX", "LO", "WE")))
    assert_that(is.character(Shape))
    assert_that(all(Shape %in% c("simple", "bathtub", "Makeham")))
  }
  
  if("gro" %in% Sections){
    assert_that(is.data.frame(Weights))
    assert_that(Weights %has_name% c("MeasurementValue", "MeasurementDate", "CollectionScopeType", "UnitOfMeasure", "EstimatedMeasurement", "RecordType", "MeasurementType", "AnimalAnonID", "RecordingInstitution"))
    assert_that(is.numeric( MinNIGro))
    assert_that( MinNIGro > 0)
    assert_that(is.numeric(MinNGro))
    assert_that(MinNGro > 0)
    assert_that(is.character(ModelsGro))
    assert_that(all(ModelsGro %in% c("logistic", "gompertz", "chapmanRichards", "vonBertalanffy", "polynomial", "gam")), msg = "The growth models supported are: logistic, gompertz, chapmanRichards, vonBertalanffy, and polynomial, in addition to GAM.")}
  
  if("rep" %in% Sections){
    assert_that(is.data.frame(Parents))
    assert_that(is.data.frame(Move))
    assert_that(is.data.frame(Contraceptions))
    assert_that(Move %has_name% c("AnimalAnonID", "To", "Date"))
    assert_that(Collection %has_name% c("AnimalAnonID", "ScopeType", "ChangeDate"))
    assert_that(parent %has_name% c("ParentAnonID", "ParentCollectionScopeType", 
                                    "OffspringCollectionScopeType", "AnimalAnonID",
                                    "ParentOriginType", "Probability"))
    assert_that(all(RepSect %in% c("agemat", "litter")))
    assert_that(is.numeric(ParentPercDam))
    assert_that(ParentPercDam > 0)
    assert_that(is.numeric(ParentPercSire))
    assert_that(ParentPercSire > 0)
    assert_that(is.numeric(MinNRepro))
    assert_that(MinNRepro > 0)
    assert_that(is.numeric(MinNPaRepro))
    assert_that(MinNPaRepro > 0)
    assert_that(is.numeric(MinNLitter))
    assert_that(MinNLitter > 0)
    assert_that(is.numeric( MinNSeas))
    assert_that( MinNSeas > 0)
    assert_that(is.numeric( NDay))
    assert_that( NDay >= 0)
  }
  

# Prepare data -----------------------------------------------------------------
  # Extract Species Data
  Dat <- select_species(Species, Animal, Collection,  
                        UncertBirth = UncertBirth, BirthType = BirthType,
                        MinDate = MinDate , ExtractDate = ExtractDate, 
                        Global = Global) 
  repout$general = Dat$summary
  SpeciesName = stringr::str_replace(Species, " ", "_")
  
# Run Analysis for each sex category -------------------------------------------
  if(nrow(Dat$data)>0){
    for (sx in SexCats){
      cat(paste0(" ****************************  ",sx,"  ****************************\n"))
      dir.create(file.path(PlotDir, "Long_dist"), showWarnings = FALSE)
       # -------------------------- #
       # -Check for longevity gaps- #
       # -------------------------- #
      sexDat <- select_Longthreshold( Dat$data,  SexCats = sx, 
                                      PlotDir= glue::glue("{PlotDir}/Long_dist/"),
                                      MinN = MinN,
                                      PlotName = glue::glue("{Taxa}_{SpeciesName}_{sx}") )
      
      repout$summary[[sx]] = sexDat$summar
      if(nrow(sexDat$data)>0){
        outlLev1 = min(sexDat$summar$GapThresh,MaxOutl, na.rm = T)
        if (outlLev1 ==100){
          data_sel <-  sexDat$data
        }else{
          data_sel <-  sexDat$data%>%
            filter(!!sym(paste0("above", outlLev1))==0)
        }
        if(nrow(data_sel)>0){
          # ------------------------------ #
          # ---- Reproduction module: ----
          # ------------------------------ #
          # Reproduction module list:
          if ("rep" %in% Sections) {
            cat("Reproduction Running ----------------------------------------\n")
            # Reproduction module list:
            Repse = RepSect
            if(sx == "Male"){Repse = RepSect%>%stringr::str_subset("litter", negate = T)}
            repout$repr[[sx]] <- Rep_main(coresubset= data_sel, Collection, Parents, Move,  
                                          RepSect = Repse,
                                          BirthType_parent = BirthType, BirthType_offspring = BirthType, 
                                          Global = Global, MinInstitution  = MinInstitution , 
                                          MinNRepro = MinNRepro, MinNPaRepro =  MinNPaRepro,
                                          ParentPercDam = ParentPercDam, 
                                          ParentPercSire = ParentPercSire,
                                          MinNLitter = MinNLitter, NDay = NDay,
                                          MinNSeas =  MinNSeas)
          }
           #Save age at maturity
            agemat = NA
            if(length(repout$repr[[sx]])>0){
              if(repout$repr[[sx]]$summary$amat_analyzed){
                agemat = repout$repr[[sx]]$agemat$ageMat
              }
            }
          
          # -------------------------- #
          # ---- Survival Module: ----
          # -------------------------- #
          # Run survival analyses:
          if ("sur" %in% Sections) {
            dir.create(file.path(PlotDir, "Survival"), showWarnings = FALSE)
            cat("Survival Running ------------------------------------------------\n")
            repout$surv[[sx]] <- Sur_main(Data = sexDat$data,  
                                          DeathInformation = DeathInformation,
                                          BirthType = BirthType,
                                          PlotDir = glue::glue("{PlotDir}/Survival/"),
                                          MaxAge = MaxAge,
                                          Models = ModelsSur, Shape= Shape, 
                                          MinAge =MinAge, 
                                          AgeMat = agemat,
                                          OutlLev1 =outlLev1, 
                                          MinMLE = MinMLE, MaxLE =  MaxLE,
                                          LastDead = LastDead,
                                          MinDate = MinDate, MinNSur = MinNSur, 
                                          MaxNSur = MaxNSur, 
                                          MinInstitution = MinInstitution,
                                          UncertDeath = UncertDeath,
                                          MinLx = MinLx, MinBirthKnown = MinBirthKnown, 
                                          niter = niter, burnin = burnin, thinning = thinning, 
                                          nchain = nchain, ncpus = ncpus,
                                          PlotName = glue("{Taxa}_{SpeciesName}_{sx}") )
            #Plot survivorship for both sexes if available
            if(sx == "Female" && length(repout$surv$Male$from0$summary$analyzed)==1){
              if(!is.null(PlotDir) & repout$surv$Male$from0$summary$analyzed& repout$surv$Female$from0$summary$analyzed ){
                pdf(file = paste0(PlotDir,"/Survival/",Taxa,"_", SpeciesName,"_surMF.pdf", sep=""), width = 6, height = 6)
                plot(NULL, main = glue("{Taxa}_{SpeciesName}"), 
                     ylim = c(min(repout$surv$Male$from0$bastaRes$surv$nocov, repout$surv$Female$from0$bastaRes$surv$nocov),
                              max(repout$surv$Male$from0$bastaRes$surv$nocov, repout$surv$Female$from0$bastaRes$surv$nocov)) , 
                     xlim = c(min(repout$surv$Male$from0$bastaRes$x, repout$surv$Female$from0$bastaRes$x),
                              max(repout$surv$Male$from0$relex_from0$Age, repout$surv$Female$from0$relex_from0$Age)),
                     xlab = 'Age', ylab = "Survivorship")
                polygon(y = c(repout$surv$Female$from0$bastaRes$surv$nocov[2,], 
                              rev(repout$surv$Female$from0$bastaRes$surv$nocov[3,])), 
                        x =c(repout$surv$Female$from0$bastaRes$x, 
                             rev(repout$surv$Female$from0$bastaRes$x)), 
                        col=rgb(1, 0, 0,0.5))
                polygon(y = c(repout$surv$Male$from0$bastaRes$surv$nocov[2,],
                              rev(repout$surv$Male$from0$bastaRes$surv$nocov[3,])),
                        x = c(repout$surv$Male$from0$bastaRes$x, 
                              rev(repout$surv$Male$from0$bastaRes$x)),
                        col=rgb(0, 0, 1,0.25))
                dev.off()
              }
            }
          }
          
          
          # ----------------------------- #
          # ---- Body weight module: ----
          # ----------------------------- #
          # Growth module list:
          if ("gro" %in% Sections) {
            dir.create(file.path(PlotDir, "Growth"), showWarnings = FALSE)
            cat("Growth Running ----------------------------------------------\n")
            repout$weig[[sx]] <- Gro_Main(data = Weights, coresubse = data_sel,
                                          Taxa = Taxa, Species = Species,
                                          BirthType = BirthType, 
                                          AgeMat = agemat, percentiles = c(2.5,97.5),
                                          PlotDir = glue::glue("{PlotDir}/Growth/"), type = "weight",
                                          UncertDate = UncertDate,
                                          MeasureType = MeasureType,
                                          MinInstitution  = MinInstitution ,
                                          MinNGro = MinNGro, MinNIGro = MinNIGro, 
                                          models = ModelsGro,
                                          MinDate = MinDate, PlotName = glue("{Taxa}_{SpeciesName}_{sx}") )
            print(repout$weig[[sx]]$Captive$wSummar$error)
          }
        }
      }
    }
  }else{
    warnings(glue::glue("No data for {Species}"))
  }
  
  return(repout)
}

