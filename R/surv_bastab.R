# WARNING - Generated by {fusen} from dev/flat_survival.Rmd: do not edit by hand

#' Create Basta data frame
#' 
#' Check column names and succession of dates to prepare the data for BASTA.
#'
#' @param coresubset  \code{data.frame} including at least the following columns *AnimalAnonID*, *binSpecies*, *Class*, *Order*, *Family*, *CommonName*, *BirthDate*, *DepartDate*, *EntryDate*, *MaxBirthDate*, *MinBirthDate*, *EntryType*, and *DepartType*
#' @param DeathInformation  \code{data.frame} including at least the following columns *AnimalAnonID* and *RelevantDeathInformationType*
#' @param earliestDate \code{character 'YYYY-MM-DD'} Earlier date to be included. Default = NA
#' @param latestDate \code{character 'YYYY-MM-DD'} LAtest date to be included. Default = NA
#' @param otherCovars \code{vector of character}. Additional variables to include in the data Default = NA
#' @param excludeStillbirth \code{logical} Whether to exclude still births. Default = FALSE
#' 
#' @details
#' This function removes:
#' * individuals with NA in the columns BirthDate, MinBirthDate, MaxBirthDate, EntryDate, and DepartDate.
#' * individuals for which the dates from min birth date/ entry date to Depart date do not follow one another.
#' * Still born individuals if required
#' * individuals with depart date anterior to earliest date
#' * individuals with entry date posterior to latest date
#' * Depart date posterior to latest date are changed to latest date. These individuals are considered as right-censored.
#'
#' @return the subset dataset in the basta format
#' 
#' @export
#' @importFrom tidyr replace_na
#'
#' @examples
#' data(core)
#' data(deathinformation)
#' out<- surv_Bastab(core, DeathInformation = deathinformation,
#'                   earliestDate = '1990-01-01', latestDate = '2020-12-31', 
#'                   otherCovars = NA, excludeStillbirth = TRUE)
#'
#'
surv_Bastab <- function (coresubset, DeathInformation, earliestDate = NA, latestDate = NA, 
                         otherCovars = NA, excludeStillbirth = FALSE) 
{ 
  inclcols <- c("AnimalAnonID", "binSpecies", "Class", 
                "Order", "Family", "CommonName", "BirthDate", "MinBirthDate", 
                "MaxBirthDate", "EntryDate", "DepartDate", "EntryType", 
                "DepartType")
  assert_that(coresubset %has_name% inclcols)
  assert_that(DeathInformation %has_name% c("AnimalAnonID","RelevantDeathInformationType"))
  assert_that(is.logical(excludeStillbirth))
  
  
  if (!is.na(otherCovars)) {
    assert_that(coresubset %has_name% otherCovars)
    inclcols <- c(inclcols, otherCovars)
    ncolnames <- c(ncolnames, otherCovars)
  }
  
  bastadat <- coresubset[, inclcols]%>%
    left_join(DeathInformation%>%select(AnimalAnonID, RelevantDeathInformationType)%>%
                filter(RelevantDeathInformationType %in% c("Stillborn","Fetal death")), by = "AnimalAnonID")
  
  colnames(bastadat) <- c("AnimalAnonID", "binSpecies", "Class", 
                          "Order", "Family", "CommonName", "Birth.Date", "Min.Birth.Date", 
                          "Max.Birth.Date", "Entry.Date", "Depart.Date", "Entry.Type", 
                          "Depart.Type", "RelevantDeathInformationType")
  
  
  #Earliest and latest dates
  if (is.na(earliestDate)) {
    earliestDate <- min(bastadat$Min.Birth.Date, na.rm = TRUE)
  }else{
    earliestDate <- lubridate::as_date(earliestDate)
  }
  if (is.na(latestDate)) {
    latestDate <- lubridate::today()
  }else{
    latestDate <- lubridate::as_date(latestDate)
  }
  
  bastadat <- bastadat%>%
    mutate(Depart.Date = lubridate::as_date(Depart.Date),
           Entry.Date = lubridate::as_date(Entry.Date),
           Min.Birth.Date = lubridate::as_date(Min.Birth.Date),
           Max.Birth.Date = lubridate::as_date(Max.Birth.Date),
           Birth.Date = lubridate::as_date(Birth.Date)
    )%>%
    filter(Depart.Date >= earliestDate,
           Entry.Date <= latestDate)%>%
    tidyr::drop_na(c(Birth.Date, Min.Birth.Date, Max.Birth.Date, Entry.Date, Depart.Date))%>%
    filter((Min.Birth.Date <= Birth.Date)%>% replace_na(TRUE), 
           (Birth.Date <= Max.Birth.Date)%>% replace_na(TRUE), 
           (Birth.Date <= Entry.Date)%>% replace_na(TRUE), 
           (Entry.Date <= Depart.Date)%>% replace_na(TRUE))%>%
    mutate(Depart.Type = if_else (Depart.Date > latestDate, "C", Depart.Type),
           Depart.Date = if_else (Depart.Date > latestDate, latestDate, Depart.Date),
           Entry.Type  = if_else (Entry.Date < earliestDate, "C", Entry.Type),
           Entry.Date  = if_else (Entry.Date < earliestDate, earliestDate, Entry.Date)
    )
  
  if(excludeStillbirth){
    #Remove Stillborn
    bastadat <- bastadat%>%
      filter((Depart.Date != Birth.Date)%>% replace_na(TRUE),
             stringr::str_detect(RelevantDeathInformationType, "Stillborn", negate = T)%>% replace_na(TRUE),
             stringr::str_detect(RelevantDeathInformationType, "Fetal death", negate = T)%>% replace_na(TRUE))
  }%>%
    select(-"RelevantDeathInformationType")
  
  
  return(bastadat)
}
