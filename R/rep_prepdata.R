# WARNING - Generated by {fusen} from dev/flat_repro.Rmd: do not edit by hand

#' Prepare Reproduction date
#' 
#' Prepare reproduction data including age of parent at birth, offspring sex and birth date and data of potential reproductive individuals at each age.
#'
#' @param coresubset \code{data frame} cleaned core data including only the selected individuals. It must includes at least the following columns: *anonID*, 'birthType', *MaxBirthDate*, *MinBirthDate*, *DepartDate*, *BirthDate*,*Sex*, and *firstInst*
#' @param collection \code{data frame} Collection data including at least the following columns: *AnimalID*, *ScopeType*, *ChangeDate*
#' @param parent \code{data frame} Parent data including at least the following columns: *ParentAnonID*, *ParentCollectionScopeType*, *OffspringCollectionScopeType*, *AnonID*, *ParentOriginType*, *Probability*
#' @param moves \code{data frame} Moves data including at least the following columns: *AnonID*, *To*, *Date*
#' @param BirthType_parent \code{character} Captive, Wild, or All. Default =  "Captive"
#' @param BirthType_offspring \code{character} Captive, Wild, or All. Default =  "Captive"
#' @param Age_uncert \code{numeric} Maximum uncertainty (= MaxBirthDate - MinBirthDate) in birth date in days. Default = 10000
#' @param Global \code{logical} Whether only individuals belonging to global collections should be used. Default = TRUE
#'
#' @return A list including
#' * The reproduction data
#' * The potential reproductive Adults
#' * A summary including:
#'  - Nbirths: the raw number of births
#'  - Nadults: the raw number of potential reproductive adults
#'  - NOffsp: the number of offspring with known birth date and with parents with known age
#'  - NParent: the number of unique parents with known age and with offspring with known birth date
#'  - NOffsp_age: the number of offspring with known birth date and with parents with a known age > 0
#'  - NParent_age: the number of unique parents with known and positive age and with offspring with known birth date
#' 
#' @export
#'
#' @examples
#' data(core)
#' data(collection)
#' data(parent)
#' data(moves)
#'
#' Data <- Rep_prepdata (coresubset = core, collection, parent, moves,
#'                       BirthType_parent = "Captive", BirthType_offspring = "Captive"
#' )
Rep_prepdata <- function(coresubset, collection, parent, moves,
                         BirthType_parent = "Captive", BirthType_offspring = "Captive", 
                         Age_uncert = 1000000, Global = TRUE
) {
  
  assert_that(is.data.frame(coresubset))
  assert_that(is.data.frame(collection))
  assert_that(is.data.frame(parent))
  assert_that(is.data.frame(moves))
  
  assert_that(coresubset %has_name% c("anonID", 'birthType', "MaxBirthDate", 
                                      "MinBirthDate", "DepartDate", "BirthDate",
                                      "Sex", "firstInst"))
  assert_that(collection %has_name% c("AnimalID", "ScopeType", "ChangeDate"))
  assert_that(parent %has_name% c("ParentAnonID", "ParentCollectionScopeType", 
                                  "OffspringCollectionScopeType", "AnonID",
                                  "ParentOriginType", "Probability"))
  assert_that(moves %has_name% c("AnonID", "To", "Date"))
  
  assert_that(is.character( BirthType_parent))
  assert_that(BirthType_parent %in% c("Captive", "Wild", "All"))
  assert_that(is.character( BirthType_offspring))
  assert_that( BirthType_offspring %in% c("Captive", "Wild", "All"))
  assert_that(is.numeric(Age_uncert))
  assert_that(is.logical(Global))
  
  fertSumm <- tibble(Nbirths = 0,
                     Nadults = 0,
                     NOffsp = 0, NParent = 0,
                     NOffsp_age = 0, NParent_age = 0
  )
  
  #Offspring               
  if (BirthType_offspring != "All"){
    offspSub <- coresubset %>%
      filter(stringr::str_detect(birthType, pattern = BirthType_offspring))
  }else{offspSub<- coresubset}
  # Number of birth records:
  fertSumm$Nbirths <- nrow(offspSub)
  
  
  # Adults:
  if (BirthType_parent != "All"){
    ADULTS <- core %>%
      filter(stringr::str_detect(birthType, pattern = BirthType_parent))
  }else{ADULTS<- core}
  
  ADULTS <- ADULTS%>%
    filter(as.numeric(MaxBirthDate - MinBirthDate) < Age_uncert)%>%
    # Find Depart ages of all inds in adults table:
    mutate(ageAds = ceiling(as.numeric(DepartDate - BirthDate) / 365.25))%>%
    #increase the table to have a row per individual and per age
    tidyr::uncount(weights = ageAds, .id = "n", .remove = F) %>%
    mutate(Age = ageAds - n,
           Date_age = BirthDate + lubridate::years(Age))%>%
    distinct()
  
  if(Global){
    ADULTS <- ADULTS%>%
      #paste collection for each individual and age
      left_join(collection%>%as_tibble%>%
                  select(AnimalID, ScopeType, ChangeDate)%>%rename(anonID = AnimalID)%>% distinct(), 
                by = "anonID", relationship = "many-to-many")%>%
      mutate(dist = purrr::map2_dbl(Date_age, ChangeDate, difftime)) %>%
      filter(dist >= 0)%>%
      group_by(anonID, Age) %>%
      mutate(maxtime = min(dist)) %>%
      ungroup()%>%
      filter(maxtime  == dist) %>%
      dplyr::select(-maxtime , -dist, -ChangeDate, -n)%>%
      filter(ScopeType == "Global")
    
    parent <- parent %>%
      filter(ParentCollectionScopeType == "Global",
             OffspringCollectionScopeType == "Global")
  }
  
  # Number of adult records:
  fertSumm$Nadults <- length(unique(ADULTS$anonID))
  
  
  if ( fertSumm$Nadults > 0) {
    
    #select parents and remove duplicated rows
    subpar <- parent %>%
      filter(ParentAnonID %in% unique(ADULTS$anonID))%>% 
      left_join(ADULTS%>%select(anonID, BirthDate,DepartDate, birthType)%>%distinct(),
                relationship = "many-to-many",
                by =c("ParentAnonID" = "anonID"))%>%
      rename(Parent_BirthDate = BirthDate,
             Parent_DepartDate = DepartDate,
             Parent_birthType = birthType)%>% 
      select(-c("ParentType", "ParentTypeID"))%>%
      distinct() %>% 
      #Offsping not in coresubset
      filter(AnonID %in% offspSub$anonID)%>%
      left_join(offspSub%>%select(anonID, BirthDate, Sex, firstInst),
                by =c("AnonID" = "anonID"))%>%
      rename(Offspring_BirthDate = BirthDate,
             Offspring_Inst = firstInst)%>%
      mutate(ageBirth = as.numeric(Offspring_BirthDate - 
                                     Parent_BirthDate) / 365.25)%>%
      left_join(moves%>%as_tibble%>%
                  select(AnonID, To, Date), 
                by = c("ParentAnonID" = "AnonID"), relationship = "many-to-many")%>%
      mutate(dist = purrr::map2_dbl(Offspring_BirthDate , Date, difftime)) %>%
      filter(dist >= 0)%>%
      group_by(AnonID) %>%
      mutate(mintime = min(dist)) %>%
      ungroup()%>%
      filter(mintime  == dist) %>%
      dplyr::select(-mintime , -dist, -Date)%>%
      rename(currentInst = To)%>%
      distinct()
    
    
    # Number of births
    fertSumm$NOffsp <- length(unique(subpar$AnonID))
    fertSumm$NParent <- length(unique(subpar$ParentAnonID))
    
    
    
    if (fertSumm$NOffsp   > 0 ) {
      
      
      #Keep only repro with age of parents at birth >0 
      subpar <- subpar%>%
        ## VERIFIER QUE J4AI Qu'une ligne par couple parent/enfantXXXXXXXXXXXXXXXXXXXXXXX
        group_by(AnonID, ParentOriginType, ParentAnonID,  
                 OffspringCollectionScopeType, ParentCollectionScopeType, 
                 Parent_BirthDate, Parent_birthType, Offspring_BirthDate,
                 Sex, ageBirth, currentInst,  Offspring_Inst)%>%
        summarise(Probability = max(Probability))%>%
        filter(ageBirth>0)%>%ungroup()
      
      fertSumm$NOffsp_age <- length(unique(subpar$AnonID))
      fertSumm$NParent_age <- length(unique(subpar$ParentAnonID))
      
    }
  }
  
  # XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
  # # Find which individuals are in the contraception data:
  #           ADULTS <- ADULTS %>% 
  #             left_join(newContra%>%as_tibble%>%mutate(anonID = as.numeric(anonID)), 
  #                       by = "anonID", relationship = "many-to-many")%>%
  #             mutate(date = case_when(
  #               is.na(date)~ as_date(Date_age), 
  #               .default =as_date(date)))%>%
  #             mutate(dist = purrr::map2_dbl(Date_age , date, difftime)) %>%
  #             filter(dist >= 0)%>%
  #             group_by(anonID) %>%
  #             mutate(mintime = min(dist)) %>%
  #             ungroup()%>%
  #             filter(mintime  == dist) %>%
  #             mutate(contra = case_when(
  #               is.na(status) ~ FALSE, 
  #               status =="Inactive" ~ FALSE,
  #               .default = TRUE))%>%
  #             dplyr::select(-mintime , -dist, -date, -method, -status)%>%
  #             distinct()
  #           
  
  
  return(list(Adults = ADULTS, Reprodata = subpar, summary =  fertSumm))
  
  
  
}
