# WARNING - Generated by {fusen} from dev/flat_main.Rmd: do not edit by hand

#' Load Zims data
#' 
#' Check if selected data are already in the global environment. If not, it load them.
#'
#' @param taxa  \code{character} the name of the taxa studied
#' @param ZIMSdir \code{character} directory where to find data
#' @param type \code{vector character} the type of data to load. Default = 'core' 
#' @param extractDate \code{character 'YYYY-MM-DD'} Date of data extraction
#' @param silent \code{logical} Whether information of advancement should be printed
#' 
#' @details
#' \code{type} can take the following values : "core", "health", "institution", "moves", "parent", "weights", "lengths", "collections", "simplified_collections"
#'
#' @return A list of the data frames
#' @importFrom glue glue
#' @importFrom checkmate assert_directory_exists
#' @export
#'
#' @examples
#'
#' # #example of an environmental ncdf file saved with the package
#' # file = system.file("coretest.csv", package = 'ISRverse')
#' # ZIMSdirtest = dirname(file)
#' # 
#' # data <- Load_Zimsdata	(taxa = "Mammalia", 
#' #                            ZIMSdir = ZIMSdirtest, 
#' #                            extractDate = "2023-12-04", 
#' #                            type = 'core') 
#' # data$core
#' # unlink(ZIMSdirtest, recursive = TRUE)
#'
Load_Zimsdata	<- function (taxa, 
                           ZIMSdir, 
                           extractDate, 
                           type = 'core',
                           silent = FALSE) 
{ out <- list()
  assert_directory_exists(ZIMSdir)
  assert_that(is.character(taxa))
  assert_that(taxa %in% c("Mammalia", "Aves", "Reptilia", "Amphibia", 
                          "Chondrichthyes", "Actinopterygii"),
              msg = "taxa must one of 'Mammalia', 'Aves', 'Reptilia', 'Amphibia', 
                          'Chondrichthyes', or 'Actinopterygii'")
  assert_that(is.logical( silent))
  assert_that(is.character(extractDate))
  
  assert_that(is.character(type))
  assert_that(all(type %in%  c("contraception", "core", "health", 
                               "institution", "moves", "parent", "weights", 
                               "lengths", "collections", "simplified_collections")))
  
  ZIMSfilesdate <- stringr::str_subset(list.files(ZIMSdir), pattern = extractDate)
  
  idTaxa <-  stringr::str_subset(ZIMSfilesdate, taxa)
  assert_that(length(idTaxa) > 0,
              msg =glue("Folder for {extractDate}_{taxa} not found. Verify ZIMSdir path.")
  )
  for (ty in type){
    # Check if the data have already been load
    if (exists(sym(ty), envir = globalenv())) {
      b <- eval(sym(ty))
      if (unique(b$Class) == taxa) {
        if (!silent) {
          cat(glue::glue("{ty} already loaded."))
        }
        continue <- FALSE
      }else {
        continue <- TRUE
      }
    }else {
      continue <- TRUE}
    
    if (continue) {
      idfiles <- list.files(glue("{ZIMSdir}/{idTaxa}"), glue("sci_{ty}"))
      idfilesn <- list.files(glue("{ZIMSdir}/{idTaxa}"), glue("template_{ty}"))
      
      assert_that(length(idfiles )> 0,
                  msg =glue("{ty} file for{taxa} not found.")
      )
      assert_that(length(idfiles) < 2,
                  msg = glue("More than one {ty} file for {taxa}.")
      )
      if (!silent) {
        cat("Loading {ty}")
      }
      namesvar = readr::read_delim(glue::glue("{ZIMSdir}/{idTaxa}/{idfilesn}"), delim = "@")
      b <- readr::read_delim(glue::glue("{ZIMSdir}/{idTaxa}/{idfiles}"), delim = "@", col_names = colnames(namesvar))
        out[[ty]]<- b}
    if (!silent) {
      cat("Done.\n")
    }

  }
  return(out)
}
