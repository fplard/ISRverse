---
title: "Taxon profiles"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{taxon-profiles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ISRverse)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_main.Rmd: do not edit by hand -->

# Run Taxon Profiles

`run_txprofile()` loads the data needed and runs or updates demographic analyses for the list of species selected. It uses the following main arguments (see the help of the different functions for more details):

* `Taxa` 
* `SpeciesList
* `ZIMSDir` directory where to find data
* `AnalysisDir`  directory where to save results
* `PlotDir`: Directory to save the plots of the best models
* `ExtractDate`  Date of data extraction
* `MinDate`  Earliest date to include data
* `BirthType` Captive, Wild, or All
* `Sections` names of the sections to update in the taxon profile results: "sur", "rep" and/or "gro"
* `SexCats` Male, Female or/and All
* `ModelsSur` names of the survival basta models to run and compared: "G0", "EX", "LO" and/or "WE".
* `ModelsGro` indicating the growth models that need to be run and compared. The following models are supported : logistic, gompertz, chapmanRichards, vonBertalanffy, polynomial.

The result files are saved using the following directory \code{{AnalysisDir}\{Taxa}\{Species}.Rdata}, where `AnalysisDir` and `Taxa` are argument of the function. `Species` is the latin name of each species




```{r examples-run_txprofile}
# Here is an example but use directly your own ZIMSDir (directory to find data) 
# and AnalysisDir (directory to save the analysis)
file = system.file("sci_Animal.csv", package = 'ISRverse')
ZIMSDir = dirname(file)
AnalysisDir = paste0(tempdir(check = TRUE),'/temp')
PlotDir = paste0(AnalysisDir,'/plot')
# dir.create(AnalysisDir)
dir.create(paste0(AnalysisDir,'/Rdata'), recursive = TRUE)
dir.create(PlotDir)

#This code run the survival analysis
run_txprofile(Taxa = "Reptilia", SpeciesList = "All",
              ZIMSDir = ZIMSDir, AnalysisDir = AnalysisDir,
              PlotDir = PlotDir,
              ExtractDate = "",
              MinDate = "1980-01-01",
              Sections = c("sur"),
              SexCats = c('Male', 'Female'),
              niter = 1000, burnin = 101, thinning = 10, nchain = 3, ncpus = 3
)

list.files(PlotDir)
list.files(paste0(AnalysisDir,'/Rdata'))

unlink(AnalysisDir, recursive = TRUE)
unlink(PlotDir, recursive = TRUE)
```

# Summary tables & plots

`make_summary()` produces summary tables and plots of the demographic analyses made for all species. It uses the following arguments:

* `AnalysisDir` character} directory where to find the .Rdata files
* `SaveDir` character} directory where to save summary plots and tables
* `TaxaList` names of the Taxa studied.
* `BySex` list of the Taxa names indicating the sexes analyzed. 
* `Sections` names of the sections: "sur", "rep" and/or "gro"

it returns the main summary table


```{r examples-make_summary}
# file = system.file("sci_Animal.csv", package = 'ISRverse')
# AnalysisDir  = paste0(dirname(file),'/Rdata')
# SaveDir = paste0(tempdir(check = TRUE),'/temp')
# dir.create(SaveDir)
# 
# SummTab <- make_summary(AnalysisDir, SaveDir,
#                         TaxaList = "Reptilia",
#                         BySex = list(Reptilia = c("Male", "Female")) ,
#                         Sections = c("sur", 'gro')
# )
# list.files(SaveDir)
# 
# unlink(SaveDir, recursive = TRUE)
```

# Summary tables & plots Data Paper

`make_summary2()` produces summary tables of the demographic analyses made for all species. It uses the following arguments:

* `AnalysisDir` character} Directory where to find the analyses results: .Rdata files
* `SaveDir` character} Directory where to save summary plots and tables
* `TaxaList` names of the taxa studied.
* `BySex` list of the taxa names indicating the sexes analyzed. 
* `Sections` names of the sections: "sur", "rep" and/or "gro"

it returns the main summary table


```{r examples-make_summary2}
file = system.file("sci_Animal.csv", package = 'ISRverse')
AnalysisDir  = paste0(dirname(file),'/Rdata')
SaveDir = paste0(tempdir(check = TRUE),'/temp')
dir.create(SaveDir)

SummTab <- make_summary2(AnalysisDir, SaveDir,
                         TaxaList = "Reptilia",
                         BySex = list(Reptilia = c("Male", "Female")) ,
                         Sections = c("sur")
)
list.files(SaveDir)
unlink(SaveDir, recursive = TRUE)
```

# Figures & Tables

`Make_FigTab()` Make figures & Tables as in Data Papers. It uses the following arguments:

* `AnalysisDir` character} Directory where to find the analyses results: .Rdata files
* `SaveDir` character} Directory where to save summary plots and tables
* `Sections` names of the sections: "sur", "rep" and/or "gro"


```{r examples-Make_FigTab}
file = system.file("sci_Animal.csv", package = 'ISRverse')
AnalysisDir  = dirname(file)
SaveDir = paste0(tempdir(check = TRUE),'/temp')
dir.create(SaveDir)
out <-Make_SurFigTab (AnalysisDir, SaveDir,
                      Sections = "sur")
unlink(SaveDir, recursive = TRUE)
```

# Load zims core data

`Load_Zimsdata()` load ZIMS data frames of a given taxa It uses the following arguments:

* `Taxa` Names of the taxa studied
* `ZIMSDir` Directory where to find data
* `Species` Names of the species studied
* `Animal` Whether the core animal data should be loaded
* `tables` of data to be load: "Contraception", "HealthStatus", "Institution","InstitutionAssociation", "Move","Parent", "Weight", "Length","DeathInformation", and/or "Collection".


```{r examples-Load_Zimsdata}
file = system.file("sci_Animal.csv", package = 'ISRverse')
ZIMSDirtest = dirname(file)
Split_Zimsdata(ZIMSDir = ZIMSDirtest)

data <- Load_Zimsdata	(Taxa = "Reptilia", 
                       ZIMSDir = ZIMSDirtest, 
                       Species = list(Reptilia = "All"),
                       Animal = TRUE,
                       tables = 'Weight') 
data$Reptilia$Animal
unlink(glue::glue("{ZIMSDirtest}/Split_Reptilia"), recursive = FALSE)
```

# Split Initial extract

`Split_Zimsdata()` loads the science extract and:
* splits it by Taxa 
* selects only "Individual" for Animal Type
* adds binSpecies name
* weights and lengths: checks that measurement are > 0 and adds the following columns: Age in years, UnitOfMeasure and MeasurementValue. 

It uses the following arguments:

* `ZIMSDir` directory where to find data
* `ExtractDate` Extraction Date in character



```{r examples-Split_Zimsdata}
file = system.file("sci_Animal.csv", package = "ISRverse")
ZIMSDirtest = dirname(file)

Split_Zimsdata(ZIMSDir = ZIMSDirtest)

list.files(ZIMSDirtest, recursive = TRUE)
```

# Output for Dev team

`make_summary()` produces summary tables and plots of the demographic analyses made for all species. It uses the following arguments:

* `SpeciesTable` Data frame including 2 columns: *Class* and *Species*
* `AnalysisDir` directory where to find the .Rdata files
* `SaveDir` directory where to save summary plots and tables
* `TaxaList` names of the Taxa studied.
* `BySex` list of the Taxa names indicating the sexes analyzed. 
* `Sections` names of the sections to update in the taxon profile results: "sur", "rep" and/or "gro"

it returns the main summary table


```{r examples-Tx_devout}
# file = system.file("sci_Animal.csv", package = 'ISRverse')
# AnalysisDir  = paste0(dirname(file),'/Rdata')
# SaveDir = paste0(tempdir(check = TRUE),'/temp')
# dir.create(SaveDir)
# SpeciesTable = data.frame( Class = "Reptilia", Species = "Testudo hermanni")
# Tx_devout(SpeciesTable, AnalysisDir, SaveDir,
#                         TaxaList = "Reptilia",
#                         BySex = list(Reptilia = c("Male", "Female")) ,
#                         Sections = c("sur", 'gro')
# )
# list.files(SaveDir)
# unlink(SaveDir, recursive = TRUE)
```

