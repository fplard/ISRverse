---
title: "Taxon profiles"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{taxon-profiles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ISRverse)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_main.Rmd: do not edit by hand -->

# Run Taxon Profiles

`run_txprofile()` loads the data needed and runs or updates demographic analyses for the list of species selected. It uses the following main arguments (see the help of the function for more):

* `taxa` 
* `Species_list
* `ZIMSdir` directory where to find data
* `AnalysisDir`  directory where to save results
* `PlotDir`: Directory to save the plots of the best models
* `extractDate `  Date of data extraction
* `minDate`  Earlier date to include data
* `Birth_Type` Captive, Wild, or All
* `Sections` names of the sections to update in the taxon profile results: "sur", "rep" and/or "gro"
* `sexCats` Male, Female or/and All
* `models_sur` names of the survival basta models to run and compared: "G0", "EX", "LO" and/or "WE".
* `models_gro` indicating the growth models that need to be run and compared. The following models are supported : logistic, gompertz, chapmanRichards, vonBertalanffy, polynomial.

The result files are saved using the following directory \code{{analysisDir}\{taxa}\{species}.Rdata}, where `analysisDir` and `taxa` are argument of the function. `species` is the latin name of each species




```{r examples-run_txprofile}
# Here is an example but use directly your own ZIMSdir (directory to find data) 
# and analysisDir (directory to save analysis)
file = system.file("sci_Animal.csv", package = 'ISRverse')
ZIMSdir = dirname(file)
AnalysisDir = paste0(tempdir(check = TRUE),'\\temp')
PlotDir = paste0(tempdir(check = TRUE),'\\temp\\plot')
dir.create(AnalysisDir)
dir.create(paste0(tempdir(check = TRUE),'\\temp\\Rdata'))
dir.create(PlotDir)

#This code run the survival analysis
run_txprofile(taxa = "Reptilia", Species_list = "All",
              ZIMSdir = ZIMSdir, AnalysisDir = AnalysisDir,
              PlotDir = PlotDir,
              extractDate = "",
              minDate = "1980-01-01",
              Sections = c("sur"),
              sexCats = c('Male', 'Female'),
              niter = 1000, burnin = 101, thinning = 10, nchain = 3, ncpus = 3
)

list.files(PlotDir)
list.files(paste0(AnalysisDir,'\\temp\\Rdata'))

unlink(AnalysisDir, recursive = TRUE)
unlink(PlotDir, recursive = TRUE)

```

# Summary tables & plots

`make_summary()` produces summary tables and plots of the demographic analyses made for all species. It uses the following arguments:

* `AnalysisDir` character} directory where to find the .Rdata files
* `SaveDir` character} directory where to save summary plots and tables
* `taxaList` names of the taxa studied.
* `BySex` list of the taxa names indicating the sexes analyzed. 
* `Sections` names of the sections to update in the taxon profile results: "sur", "rep" and/or "gro"

it returns the main summary table


```{r examples-make_summary}
file = system.file("sci_Animal.csv", package = 'ISRverse')
AnalysisDir  = paste0(dirname(file),'\\Rdata')
SaveDir = paste0(tempdir(check = TRUE),'\\temp')
dir.create(SaveDir)

SummTab <- make_summary(AnalysisDir, SaveDir,
                        taxaList = "Reptilia",
                        BySex = list(Reptilia = c("Male", "Female")) ,
                        Sections = c("sur", 'gro')
)
list.files(SaveDir)

unlink(SaveDir, recursive = TRUE)
```

# Load zims core data

`Load_Zimsdata()` load ZIMS data frames of the taxa selected in a list. It uses the following arguments:

* `taxa` the name of the taxa studied
* `ZIMSdir` directory where to find data
* `species` names of the species studied
* `Animal` Whether the core animal data should be loaded
* `tables` of data to load: "Contraception", "HealthStatus", "Institution","InstitutionAssociation", "Move","Parent", "Weight", "Length","DeathInformation", and/or "Collection".


```{r examples-Load_Zimsdata}
file = system.file("sci_Animal.csv", package = 'ISRverse')
ZIMSdirtest = dirname(file)
Split_Zimsdata	(ZIMSdir = ZIMSdirtest)

data <- Load_Zimsdata	(taxa = "Reptilia", 
                       ZIMSdir = ZIMSdirtest, 
                       species = list(Reptilia = "All"),
                       Animal = TRUE,
                       tables = 'Weight') 
data$Reptilia$Animal
unlink(glue::glue("{ZIMSdirtest}/Split_Reptilia"), recursive = FALSE)
```

# Split Initial extract

`Split_Zimsdata()` loads the science extract and:
* splits it by taxa 
* selects only "Individual" for Animal Type
* adds binSpecies name
* weights and lengths: checks that measurement are > 0 and adds the following columns: Age in years, UnitOfMeasure and MeasurementValue. 

It uses the following arguments:

* `ZIMSdir` directory where to find data
* `extractDate` Extraction Date in character



```{r examples-Split_Zimsdata}
file = system.file("sci_Animal.csv", package = "ISRverse")
ZIMSdirtest = dirname(file)

Split_Zimsdata(ZIMSdir = ZIMSdirtest)

list.files(ZIMSdirtest, recursive = TRUE)
```

# Output for Dev team

`make_summary()` produces summary tables and plots of the demographic analyses made for all species. It uses the following arguments:

* `SpeciesTable` Data frame including 2 columns: *Class* and *Species*
* `AnalysisDir` directory where to find the .Rdata files
* `SaveDir` directory where to save summary plots and tables
* `taxaList` names of the taxa studied.
* `BySex` list of the taxa names indicating the sexes analyzed. 
* `Sections` names of the sections to update in the taxon profile results: "sur", "rep" and/or "gro"

it returns the main summary table


```{r examples-Tx_devout}
# file = system.file("sci_Animal.csv", package = 'ISRverse')
# AnalysisDir  = paste0(dirname(file),'\\Rdata')
# SaveDir = paste0(tempdir(check = TRUE),'\\temp')
# dir.create(SaveDir)
# SpeciesTable = data.frame( Class = "Reptilia", Species = "Testudo hermanni")
# Tx_devout(SpeciesTable, AnalysisDir, SaveDir,
#                         taxaList = "Reptilia",
#                         BySex = list(Reptilia = c("Male", "Female")) ,
#                         Sections = c("sur", 'gro')
# )
# list.files(SaveDir)
# unlink(SaveDir, recursive = TRUE)
```

