---
title: "Taxon profiles"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{taxon-profiles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ISRverse)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_main.Rmd: do not edit by hand -->

# Run Taxon Profiles

`run_txprofile()` loads the data needed and runs or updates demographic analyses for the list of species selected. It uses the following main arguments (see the help of the function for more):

* `taxa` 
* `Species_list
* `ZIMSdir` directory where to find data
* `AnalysisDir`  directory where to save results
* `PlotDir`: Directory to save the plots of the best models
* `extractDate `  Date of data extraction
* `minDate`  Earlier date to include data
* `Sections` names of the sections to update in the taxon profile results: "sur", "rep" and/or "gro"
* `sexCats` Male, Female or/and All
* `models_sur` names of the survival basta models to run and compared: "G0", "EX", "LO" and/or "WE".
* `models_gro` indicating the growth models that need to be run and compared. The following models are supported : logistic, gompertz, chapmanRichards, vonBertalanffy, polynomial.

The result files are saved using the following directory \code{{analysisDir}\{taxa}\{species}.Rdata}, where `analysisDir` and `taxa` are argument of the function. `species` is the latin name of each species




```{r examples-run_txprofile}
# # Here is an example but use directly your own ZIMSdir(directory to find data) and analysisDir(directory to save analysis)
# file = system.file("coretest.csv", package = 'ISRverse')
# ZIMSdir = dirname(file)
# AnalysisDir = paste0(tempdir(check = TRUE),'\\temp')
# PlotDir = paste0(tempdir(check = TRUE),'\\temp\\plot')
# dir.create(AnalysisDir)
# dir.create(PlotDir)
# 
# #This code run the survival analysis for gorilla
# out <- run_txprofile(taxa = "Mammalia", Species_list = c('Gorilla gorilla'), 
#                           ZIMSdir = RastDir, AnalysisDir = AnalysisDir,
#                           PlotDir = PlotDir,
#                           extractDate = "", 
#                           minDate = "1980-01-01",
#                           Sections = "sur", 
#                           sexCats = c('Male', 'Female'),
#                          niter = 1000, burnin = 101, thinning = 10, nchain = 3, ncpus = 3
# )
# 
# list.files(PlotDir)
# list.files(AnalysisDir)
# 
# unlink(AnalysisDir, recursive = TRUE)

```

This function can be run on parallel on several computer on the same species list. In this case the following arguments need to be used:
* `inparallel` Whether this function is run in parallel on different computer. In other words: should the species list be divided? Default = FALSE
* `ipara` Id number of the computer used to select the species to run
* `npara` number of computers used in parallel
.


```{r examples2-run_txprofile}
#' \dontrun{
#' # Here is an example but use directly your own ZIMSdir(directory to find data) and analysisDir(directory #' to save analysis)
#' file = system.file("coretest.csv", package = 'ISRverse')
#' ZIMSdir = dirname(file)
#' analysisDir = paste0(tempdir(check = TRUE),'\\temp')
#' PlotDir = paste0(tempdir(check = TRUE),'\\temp\\plot')
#' dir.create(analysisDir)
#' dir.create(PlotDir)
#' 
#' #Here I want to split my analysis on two computers
#' #Run on computer 1:
#' out <- run_txprofile(taxa = "Mammalia", Species_list = c('Gorilla gorilla', "Capreolus capreolus"), 
#'                           ZIMSdir = RastDir, analysisDir = analysisDir,
#'                          PlotDir = PlotDir,
#'                        extractDate = "", 
#'                           minDate = "1980-01-01",
#'                           Sections = "sur", 
#'                           sexCats = c('Male', 'Female'), 
#'                           inparallel = TRUE, 
#'                           ipara = 1, npara = 2
#' )
#' 
#' 
#' #Run on computer 2:
#' out <- run_txprofile(taxa = "Mammalia", Species_list = c('Gorilla gorilla', "Capreolus capreolus"), 
#'                           ZIMSdir = RastDir, analysisDir = analysisDir,
#'                           PlotDir = PlotDir,
#'                       extractDate = "", 
#'                           minDate = "1980-01-01",
#'                           Sections = "sur", 
#'                           sexCats = c('Male', 'Female'), 
#'                           inparallel = TRUE,
#'                            ipara = 2, npara = 2
#' )
#' list.files(PlotDir)
#' list.files(AnalysisDir)
#'
#' unlink(analysisDir, recursive = TRUE)
#' }
```

# Summary tables & plots

`make_summary()` produces summary tables and plots of the demographic analyses made for all species. It uses the following arguments:

* `AnalysisDir` character} directory where to find the .Rdata files
* `SaveDir` character} directory where to save summary plots and tables
* `taxaList` names of the taxa studied.
* `BySex` list of the taxa names indicating the sexes analyzed. 
* `Sections` names of the sections to update in the taxon profile results: "sur", "rep" and/or "gro"

it returns the main summary table


```{r examples-make_summary}
# file = system.file("gorilla gorilla.Rdata", package = 'ISRverse')
# AnalysisDir  = dirname(file)
# SaveDir = paste0(tempdir(check = TRUE),'\\temp')
# dir.create(SaveDir)
# 
# SummTab <- make_summary (AnalysisDir, SaveDir,
#                           taxaList = "Mammalia", 
#                           BySex = list(Mammalia = c("Male", "Female")) , 
#                           Sections = c("sur", 'gro')
# )
# list.files(SaveDir)
# 
# 
# unlink(SaveDir, recursive = TRUE)

```

# Load zims core data

`Load_Zimsdata()` load ZIMS data frames of the taxa selected in a list. It uses the following arguments:

* `taxa` the name of the taxa studied`
* `ZIMSdir` directory where to find data
* `extractDate` Date of data extraction
* `type` of data to load: "core", "health", "institution", "moves", "parent", "weights", "lengths", "collections", and/or "simplified_collections"


```{r examples-Load_Zimsdata}

# #example of an environmental ncdf file saved with the package
# file = system.file("coretest.csv", package = 'ISRverse')
# ZIMSdirtest = dirname(file)
# 
# data <- Load_Zimsdata	(taxa = "Mammalia", 
#                            ZIMSdir = ZIMSdirtest, 
#                            extractDate = "2023-12-04", 
#                            type = 'core') 
# data$core
# unlink(ZIMSdirtest, recursive = TRUE)

```

