---
title: "Growth"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{growth}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ISRverse)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_growth.Rmd: do not edit by hand -->

<!-- Run this 'development' chunk -->
<!-- Store every call to library() that you need to explore your functions -->


# gro_remoutliers

This function removes the outliers from a dataset of weights. This function takes as arguments:

* `data_weight` a data frame that must include at least the columns `MeasurementValue` and `Age`.
* `taxa` the name of the taxa studied
* `ageMat` the MINIMUM age at sexual maturity. The function takes as threshold 1.2*ageMat to differentiate juveniles (still growing) from adults
* `maxweight`
* `variableid` name of the column including individual IDs. Defaut = "AnonID". It must also be a column of `data_weight`
* `minq` Sensitivity of the function to remove outliers using percentiles, between 0 and 1. Default =  0.025
* `IQR` influences the sensitivity of the function to remove outliers using generalized additive model of growth. It should be above 1 Default =  2.75. A higher number makes the function less sensitive to find outliers.
* `perc_weight_min`  Minimum percentage of weight that an individual can naturally lose or gain during a year . Default =  0.2 (20%)
* `perc_weight_max`  Maximum percentage of weight that an individual can naturally lose or gain during a year . Default =  2.5 (250%)

This function follow 4 different steps to highlight outliers:
1/ It removes the measures higher than the argument `maxweight` (Instead of using the OrdMag Fernando that was removing only very extreme values, a maximum value was set for each taxa).  In the default case, default values are in kilograms and are set at 7000kg for Mammalia, 200kg for Aves, 1500kg for Reptilia, 100kg for Amphibia, 1000kg for Chondrichthyes and 500kg for Actinopterygii.
2/ Independently on adults and juveniles, it uses the function Gro_Rout_quan() to removes outliers based on percentiles on adults and juveniles. It uses sliding windows of age for juveniles. You can choose the number of individuals included in each interval of the sliding window using the argument `Ninterval_juv`.
3/  Independently on adults and juveniles, it uses the function Gro_lin_ind() to build generalized additive models for each individual trajectories with at least `min_Nmeasures` measures and remove outliers based on the residuals of the models.
4/  It uses the function Gro_lin_ind() to build a common generalized additive model for all growth trajectories and remove outliers based on the residuals of the models.

The function returns:

* The data frame including the column `KEEP` a numeric vector of 1 and 0 indicating the measures to keep. The 0 signal outliers. Other additional columns keep1, keep2, keep3 indicates the individuals highlighted as outliers (0) in steps 1 to 3.




```{r examples-Gro_remoutliers}
data(weights)
weights = Gro_remoutliers(weights, taxa = "Mammalia", ageMat = 10)

plot(MeasurementValue ~Age, data = weights)
#Show the four steps used to remove outliers
#1/ using maximum value
points(MeasurementValue ~Age, data = weights%>%dplyr::filter(keep1==0), col = "red", pch = 16) 
#2/ using Inter quartile range
points(MeasurementValue ~Age, data = weights%>%dplyr::filter(keep2==0, keep1==1 ), col = "green", pch = 16) 
#3a/ using individual trajectories
points(MeasurementValue ~Age, data = weights%>%dplyr::filter(keep3==0, keep2==1), col = "cyan", pch = 16) 
#3b/ using global log-linear model
points(MeasurementValue ~Age, data = weights%>%dplyr::filter(KEEP==0, keep3==1), col = "blue", pch = 16) 

#Checking outliers highlighted in Individual trajectories
anon = unique(weights$AnonID[weights$keep3==0 & weights$keep2==1 ])
plot(MeasurementValue ~Age, data = weights%>%dplyr::filter(keep2==1, AnonID == anon))
points(MeasurementValue ~Age, data = weights%>%dplyr::filter(keep3==0, AnonID == anon, keep2==1), col = "cyan", pch = 16)
```

## Remove outliers from percentiles

This functions removes all values lower and higher than the median value multiplied by how many times the (100-q)th percentile is higher than the qth percentile of the distribution of weights.

The measurement values must be positive


```{r examples-Gro_Rout_quan}
z = c(rnorm(100,5,1), runif(3,40,100))
Gro_Rout_quan (z, minq = 0.05)
```

## Linearize individual trajectories

This function takes as arguments:

* `data_weight` a data frame that must include at least the columns `MeasurementValue` and `Age`.
* `variable_id` name of the variable including individual ids. Defaut = "AnonID". It must also be a column of  `data_weight`
* `perc_weight_min`  Minimum percentage of weight that an individual can naturally lose or gain during a year. Default =  0.2 (20%)
* `perc_weight_max`  Maximum percentage of weight that an individual can naturally lose or gain during a year. Default =  2.5 (250%). This value is used only after 1 year old 
* `IQR` influences the sensitivity of the function to remove outliers. It should be above 1 Default =  1.5. A higher number makes the function less sensitive to find outliers.
* `remove_ext` Do you want to keep the two first and two last observations of individual trajectories? These points may often be highlighted as false outliers. Default =  TRUE
*  `traj_ind` Do you want to build a model at the level of the individual trajectory  Default =  TRUE. If yes, each individual trajectory must have at least 5 measures. 

The function uses build generalized additive model of the measurement value in relation to age. It flags as outliers all measures for which the residuals from the linear model are above  IQR * the inter quantile interval (quantile(0.9) - quantile(0.1)) of the residuals. `perc_weight_min` and `perc_weight_max` limit the values that must be considered as outliers.


```{r example-Gro_lin_ind}
data(weights)

#We use only trajectories for which the number of individual datapoints is > 6
weights <- weights%>%
  dplyr::group_by(AnonID)%>%
  dplyr::mutate(nb= dplyr::n())%>%
  dplyr::ungroup()%>%
  dplyr::filter(nb >6)

weights <- weights%>%Gro_lin_ind(traj_ind = TRUE)
as.numeric(weights$Keep2)

weights_pop <- weights%>%Gro_lin_ind(traj_ind = FALSE)
```

