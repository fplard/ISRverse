---
title: "Survival"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{survival}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ISRverse)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_survival.Rmd: do not edit by hand -->

# Main survival Analysis

`Sur_main()` runs the survival analysis (see next function : `Sur_ana()`) and estimates associated key survival metrics. In addition to the arguments of `Sur_ana()`, `Sur_main()` includes the main following arguments:

* `DataCore` the core data of the species from ZIMS including at least the following columns *AnimalAnonID*, *BirthDate*, *DepartDate*, *EntryDate*, *MaxBirthDate*, *MinBirthDate*, *EntryType*, *DepartType*, *FirstHoldingInstitution*, *LastHoldingInstitution*, *SexType*, and *BirthType*.
* `DeathInformation` data.frame including at least the following columns *AnimalAnonID* and *RelevantDeathInformationType*
* `BirthType`: The birth type to be selected: Captive, Wild, or All
* `PlotDir`: Directory to save the plots of the selected model

It returns a list including:
* a summary of the data selected
* the basta fit of the selected model
* the DIC table comparing the fit  of the different models
* the remaining life expectancy per age
* key survival metrics
* Statistics to check the fit of the selected model


```{r examples-Sur_main}
data(core)
data(deathinformation)
out <- Sur_main(core, DeathInformation = deathinformation, BirthType = "All",
                Models = "GO", Shape = "simple",
                niter = 1000, burnin = 101, thinning = 10, nchain = 3, ncpus = 3)
```

# Survival Analysis

This functions runs basta survival models on the data after checking conditions for correct convergence of the models. It includes the following arguments:
* `Data`including at least the following columns *AnimalAnonID*, *BirthDate*, *DepartDate*, *EntryDate*, *MaxBirthDate*, *MinBirthDate*, *EntryType*, *DepartType*, *FirstHoldingInstitution*, *LastHoldingInstitution*, *SexType*, and *BirthType*.
* `DeathInformation` data.frame including at least the following columns *AnimalAnonID* and *RelevantDeathInformationType*.
* `Models` names of the basta Models to run: "G0", "EX", "LO" and/or "WE". see ?basta for more information. Default = "GO".
* `Shape` shape of the basta model: "simple", "Makeham", "bathtub".  see ?basta for more information. Default = "simple".

The user should define different filters to select data and run the survival analyses. The main ones are: 
* `UncertDeath` Maximum uncertainty accepted for death date, in days.
* `MinNSur` Minimum number of individual records needed to run the survival analysis.
* `MaxNSur` Maximum number of individual records to run the survival analysis.
* `MinLx` Minimum reached survivorship from the raw Kaplan Meier analysis needed to run the survival analysis.
* `MinBirthKnown` Minimum proportion of individuals with a known birth month in the data.
* `MinInstitution` Minimum number of institutions that should hold records to run the survival analysis.

It return a list including:
* a summary of the data used
* the basta fit of the best model
* the DIC table comparing the different fit of the Models


```{r examples-Sur_ana}
data(core)
data(deathinformation)
out <- Sur_ana(core,  DeathInformation = deathinformation, Models = "GO", Shape = "simple",
               niter = 1000, burnin = 101, thinning = 10, nchain = 3, ncpus = 3)
```

# Key survival metrics

`Sur_out()` estimates key metrics from the selected survival model and returns plots for the survival model. It includes the main following arguments:

* `out`: the output of the survival analysis (returns from `Sur_ana()`)
* `PlotDir`: Directory to save the plots of the best model

In addition to the outputs of the survival analysis, it returns:
* Key survival metrics estimated from either raw data, the Kaplan Meier estimator or the selected survival model. Estimates are from birth or from age at sexual maturity.
* A check list
* the remaining life expectancy per age (relex_from0)
* the probability to live 5 years more (Sur5)
* Age-specific survival  (Sur1)
* The monthly survival  (Sur1m)

It creates the associated plot


```{r examples-Sur_out}
data(core)
data(deathinformation)
out <- Sur_ana(core,  DeathInformation = deathinformation, 
                         Models = "GO", Shape = "simple",
               niter = 1000, burnin = 101, thinning = 10, nchain = 3, ncpus = 3)

out <- Sur_out(out, ncpus = 3)
```

# Create Basta data frame

This functions formats the data prior to run basta Models. It checks column names and the succession of dates for each individual. It includes the following arguments:

* `coresubset` data frame including at least the following columns *AnimalAnonID*, *binSpecies*, *Class*, *Order*, *Family*, *CommonName*, *BirthDate*, *DepartDate*, *EntryDate*, *MaxBirthDate*, *MinBirthDate*, *EntryType*, and *DepartType*
* `DeathInformation` data.frame including at least the following columns *AnimalAnonID* and *RelevantDeathInformationType*
* `EarliestDate` Earlier date to be included.
* `LatestDate` Latest date to be included.
* `OtherCovars` Additional variables to include in the data
* `ExcludeStillBirth` Whether to exclude still births.

This function returns the subset dataset excluding individuals:
* with NA in the columns BirthDate, MinBirthDate, MaxBirthDate, EntryDate, and DepartDate.
* for which the dates from min birth date/entry date to Depart date do not follow one another in a logical order.
* Still born if required
* with depart date anterior to EarliestDate
* with entry date posterior to LatestDate
* Depart dates posterior to LatestDate are changed to latest date. These individuals are considered right-censored.




```{r examples-surv_Bastab}
data(core)
data(deathinformation)
out<- surv_Bastab(core, DeathInformation = deathinformation,
                  EarliestDate = '1990-01-01', LatestDate = '2020-12-31', 
                  OtherCovars = "SexType", ExcludeStillBirth = TRUE)


```

# Estimate raw survivorship from life table

This function estimated the Kaplan-Meier table


```{r examples-Sur_ple}
entryAge = sample(c(1:10), 200, replace = TRUE)
data <- data.frame(
  entryAge = entryAge,
  deparAge =  entryAge + sample(c(0:10), 200, replace = TRUE),
  DepartType = sample(c('C', 'D'), 200, replace = TRUE))


out<-Sur_ple(data)
```

# Remaining life expectancy

`Sur_relex()` estimates the remaining life expectancy over ages. It includes the following arguments: 

* `Lx` Survivorship
* `dx` precision for age (delta between successive age)
* `xv` Age vector


```{r examples-Sur_relex}
Lx = matrix(c(seq(1,0,by = -0.1), 1,seq(0.5,0,length.out = 10)),nrow =2)
out <- Sur_relex(Lx, dx = 1, xv = c(0:10))
```

# Age-specific survival

`Sur_age()` estimates age-specific survival. It includes the following arguments: 

* `Lx` Survivorship
* `xv`  Age vector
* `Nyear` Number of year to survive. Default = 1


```{r examples-Sur_age}
Lx = matrix(c(seq(1,0,by = -0.1), 1,seq(0.5,0,length.out = 10)),nrow =2)
out <- Sur_age(Lx, Nyear = 5, xv = c(0:10))
```

# Survivorship quantile

`Sur_xx()` estimates the age at which xx% of the population is still alive. It includes the following arguments: 

* `Lx` Survivorship
* `xv` Age vector
* `xx` Proportion of the population still alive


```{r examples-Sur_90}
Lx = matrix(c(seq(1,0,by = -0.1), 1,seq(0.5,0,length.out = 10)),nrow =2)
out <- Sur_xx(Lx,  xv = c(0:10), xx = 0.1)
```

# Survivorship

`Sur_Lx()` estimates the survivorship from parameter of the survival model. It includes the following arguments: 

* `sim` iteration number if the function is run in parallel
* `theMat` The posteriors estimates of the model parameter
* `model` Name of the basta model: "G0", "EX", "LO" and/or "WE".
* `Shape` character Shape of the basta model: "simple", "Makeham", "bathtub". 
* `iseq` rows of themat to consider
* `xv`  Age vector



# Age from Kaplan Meier

`KM_age()` estimates Ages at which Lx equals given values from the Kaplan-Meier curve. It includes the following arguments: 

* `KM_tab`: The kaplan-Meier table including the columns: `Ages` and `ple`.
* `Lx`: Values of Lx for which age is requested


```{r examples-KM_age}
KM_tab = data.frame( Ages = 1:10,
                     ple = sort(runif(10, 0, 1), decreasing = TRUE))
out <- KM_age(KM_tab, Lx = c(0.5,0.1))
```

# Lx from Kaplan Meier

`KM_Lx()` estimates Lx at given ages from the Kaplan-Meier table. It includes the following arguments: 

* `KM_tab`: The kaplan-Meier table including the columns: `Ages` and `ple`.
* `Age`: Age for which Lx is requested


```{r examples-KM_Lx}
KM_tab = data.frame( Ages = 1:10,
                     ple = sort(runif(10, 0, 1), decreasing = TRUE))
out <- KM_Lx(KM_tab, Age = c(3,6.5))
```

