---
title: "Data Selection"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{data-selection}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ISRverse)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_select.Rmd: do not edit by hand -->

# Create the Species profile report

`tx_report()` runs the survival, reproduction and growth analyses for the selected species. It uses the following main arguments:

* `Taxa` Name of the taxa studied
* `Species` Name of the species studied
*  Data for each analysis: at least `Animal` and `Collection`, in addition to `Weights`, `Parents`, `Contraceptions` if needed.   
* `PlotDir`: Directory to save the plots of the selected models
* `repout` Previous result of the report for this Species if it needs to be updated
* `SexCats` Sex categories: Male, Female or All 
* `MinN` Minimum number of individuals needed to run the analyses
* `MinDate` Earliest date to include data records
* `BirthType` Captive, Wild, or All
* `ModelsSur`  Names of the survival basta models to run: "G0", "EX", "LO" and/or "WE"
* `Shape` Shape of the survival basta model to run: "simple", "Makeham", "bathtub"
* `ModelsGro` Names of the growth models that need to be fit.The following models are supported : logistic, gompertz, chapmanRichards, vonBertalanffy, polynomial.
* `RepSect` Names of the reproductive analyses to run: "agemat", "litter" and/or ...



```{r examples-tx_report}
file = system.file("sci_Animal.csv", package = 'ISRverse')
ZIMSDirtest = dirname(file)
data <- Load_Zimsdata	(Taxa = "Reptilia",
                       Species = list(Reptilia = "All"),
                       ZIMSDir = ZIMSDirtest,
                       Animal = TRUE, tables = c("Collection","DeathInformation"))

Animal<- Prep_Animal(data[["Reptilia"]]$Animal, ExtractDate="2024/08/29"  )
PlotDir = paste0(tempdir(check = TRUE),'\\temp')
dir.create(PlotDir)

out <- tx_report(Species = "Testudo hermanni", Taxa = "Reptilia",
                 Animal, data$Reptilia$Collection, 
                 BirthType = "All", UncertBirth = 3500,UncertDeath = 3500, 
                 DeathInformation =data$Reptilia$DeathInformation,
                 PlotDir = PlotDir,Sections = c('sur'),
                 SexCats = c("Male", "Female"),
                 ModelsSur = "GO", Shape = "simple",
                 ModelsGro = "vonBertalanffy",
                 niter = 1000, burnin = 101, thinning = 10, nchain = 3, ncpus = 3
)

list.files(PlotDir)
unlink(PlotDir, recursive = TRUE)

```

# Prepare Animal Data

This function checks dates and add the following columns to animal data: MinBirthDate, MaxBirthDate, MinDeathDate, MaxDeathDate, EntryDate, EntryType, DepartDate, DepartType, BirthUncertainty, and DeathUncertainty. It includes the following argument:

* `Animal`data frame including at least the following columns *AnimalAnonID*,  *BirthDate*, *BirthDateEstimateType*, *BirthDateEstimateStart*, *BirthDateEstimateEnd*, *BirthType*, *FirstAcquisitionDate*, *DeathDate*, *DeathDateEstimateType*, *DeathDateEstimateStart*, *DeathDateEstimateEnd*, *LastCommentEntryDate*, *BirthObserved*, *GlobalStatus*, and  *LastTXDate*
* `ExtractDate`  Latest possible date in the data: date used when individuals are still alive


```{r examples-Prep_Animal}
file = system.file("sci_Animal.csv", package = 'ISRverse')
ZIMSDirtest = dirname(file)

data <- Load_Zimsdata	(Taxa = "Reptilia", 
                       Species = list(Reptilia = "All"),
                       ZIMSDir = ZIMSDirtest,
                       Animal = TRUE)

Animal <- Prep_Animal(data$Reptilia$Animal, ExtractDate = lubridate::as_date("2023/12/23"))

unlink(ZIMSDirtest, recursive = FALSE)
```

# Extract Data

This function extracts the data of the specified Species that fill the condition on minimum date and global collections. It includes the following argument:

* `SpeciesName` latin name of the selected species
* `coresubset`data frame including at least the following columns *AnimalAnonID*, *binSpecies*, *BirthDate*, *DepartDate*, *EntryDate*, *MaxBirthDate*, *MinBirthDate*, *MaxDeathDate*, *MinDeathDate*, *EntryType*, *DepartType*,  *LastTXDate*, *DeathDate*, *FirstHoldingInstitution*, *LastHoldingInstitution*, *GlobalStatus*, *LastCollectionScopeType*, and *FirstCollectionScopeType*
* `Collection` data.frame including at least the following columns*RecordingInstitution*, *ChangeDate*, *ScopeType*, and *AnimalAnonID*.
* `UncertBirth` Maximum uncertainty accepted for birth date, in days
* `BirthType` Captive, Wild, or All
* `MinDate`: Earliest date to include data
* `ExtractDate`: Date of data extraction
* `Global` Whether only individuals belonging to global Collections should be used.
* `na_birthdate` Whether lines with unknown birth date should be kept.


The output is a list including:
* The subseted dataset
* a summary of the data used:
    * NRaw : Raw number of individuals
    * NDate : Number of individuals with an entry date posterior to the minimum date
    * NGlobal: Number of individuals selected from global Collections
    * NBirthType: Number of individuals selected from birth type
    * NUncertBirth: Number of individuals selected from uncertainty in birth
    * NAlive: Number of individuals still alive
    * FirstDate: Date of first record
    * MaxAgeRaw: Maximum observed age


```{r examples-select_species}
data(core)
data(collection)
out<- select_species(SpeciesName = "Testudo hermanni", coresubset = core, collection,
                     MinDate = "1980-01-01", ExtractDate = "2023-01-01")
out$summary
out$data
```

# Gap analysis in longevity

`select_Longthreshold()` runs a gap analysis on the distribution of longevity and gives the threshold value to use to avoid having gaps in longevity. It can focus on a given sex using the following arguments:

* `Data` including at least the following columns *Birth.Date*, *Depart.Date*, *Entry.Date*, and *SexType*
* `SexCats` Male, Female or All
* `MinN` Minimum number of individuals to run the gap analysis
* `PlotDir` Directory to save the plots
* `PlotName` name of the graph to be saved

It returns the data with the selected sex and additional columns showing which individuals are above the percentiles 95%, 99% and 99.9%
and a summary list including the threshold value selected for the distribution of longevity. It plots the distribution of longevity with gaps if `PlotDir` is given. 


```{r examples-select_Longthreshold}
TempDir <- paste0(tempdir(check = TRUE),'\\temp')
dir.create(TempDir)
data(core) #### CHANGE DATASET WITH ONE EXCLUDING ABOVE95 99 99.9
out <- select_Longthreshold (Data = core,  SexCats = "All", 
                             PlotDir = TempDir, PlotName = "Testudo_hermanni")
list.files(TempDir)
#reMove temporary folder
unlink(TempDir, recursive = TRUE)
```

## Find gaps in a continuous variable

`find_gaps` Looks for gaps within a continuous variable.Values of the variable are rounded and gaps are found if one integer is not represented. Gaps are returned only if the length of the gaps is 20% higher than the starting age of this gap. It uses the following arguments:

* `x` variable to analyze
* `MaxAlive` Return gaps higher than this maximum, only. Default = NA

It returns a data frame where each line is a gap described by its initial/starting age, its final/ending age and its length


```{r examples-find_gaps}
x = runif(10,0,40)
out<-find_gaps(x,MaxAlive = 5, plot = FALSE)
```

